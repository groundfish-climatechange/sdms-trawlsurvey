---
title: "DTS projection comparison"
author: "Owen Liu"
date: "9/29/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(lubridate)
library(rnaturalearth)
library(sf)
library(here)
# vista is Eric Ward's library for looking at outputs
library(vista)
library(cowplot)
library(RANN)
library(furrr)
library(future)
library(tictoc)

knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

```{r}
# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=10,color="black"),
        legend.text = element_text(size=14),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=10,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

Load functions from projection script

```{r}
rmarkdown::render(here::here('scripts','sdmTMB_projection.Rmd'),quiet=TRUE)
```

# Landings and Value

```{r}
v <- read_csv(here('data','dts_landings.csv'))
v %>% 
  rename(name=`NMFS Name`) %>% 
  mutate(Year=as.integer(Year)) %>% 
  mutate(lab=case_when(
    name=="SABLEFISH" ~ "Sablefish",
    name=="SOLE, DOVER" ~ "Dover Sole",
    name=="THORNYHEAD, LONGSPINE" ~ "Longspine Thornyhead"
  )) %>% 
  ggplot(aes(Year,Dollars/1e6,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Landings (Million $)",color="")+
  scale_x_continuous(breaks=seq(2010,2020,by=2))+
  theme(legend.position = c(0.8,0.9))
```

# Produce ensemble predictions for DTS

Use IPSL ESM for now

```{r}
dover_models <- read_rds(here::here('model output','dover sole models.rds'))
sable_models <- read_rds(here::here('model output','sablefish models.rds'))
ls_models <- read_rds(here::here('model output','longspine thornyhead models.rds'))

dover_ens <- ensemble_predictions(dover_models,gcm='ipsl')
sable_ens <- ensemble_predictions(sable_models,gcm='ipsl')
ls_ens <- ensemble_predictions(ls_models,gcm='ipsl')
```

# Ensemble Abundance and COG

```{r}
make_index(dover_models)

make_index(sable_models)

make_index(ls_models)
```

```{r}
dover_cog <- make_cog(dover_models,what="dat")
sable_cog <- make_cog(sable_models,what="dat")
ls_cog <- make_cog(ls_models,what="dat")
```

# Maps

```{r}
dover2021 <- map_year(dover_ens,yr_vec=2021,return_pred_df=T) %>% rename(dover=est)
sable2021 <- map_year(sable_ens,yr_vec=2021,return_pred_df=T)%>% rename(sable=est)
ls2021 <- map_year(ls_ens,yr_vec=2021,return_pred_df=T)%>% rename(ls=est)

dover2100 <- map_year(dover_ens,yr_vec=2100,return_pred_df=T)%>% rename(dover=est)
sable2100 <- map_year(sable_ens,yr_vec=2100,return_pred_df=T)%>% rename(sable=est)
ls2100 <- map_year(ls_ens,yr_vec=2100,return_pred_df=T)%>% rename(ls=est)
```

```{r}
dover2021_map <- map_year(dover_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
sable2021_map <- map_year(sable_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
ls2021_map <- map_year(ls_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)

plot_grid(dover2021_map,sable2021_map,ls2021_map,nrow=1)

dover2100_map <- map_year(dover_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
sable2100_map <- map_year(sable_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
ls2100_map <- map_year(ls_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
plot_grid(dover2100_map,sable2100_map,ls2100_map,nrow=1)
```

# Calculate Overlap Over Time

Schoener's D measures spatial niche overlap, or how two species use space relative to its availability.

$$1 - 0.5*\sum_{1}^{n}{|p_{1,i}-p_{2,i}|}$$


Also calculating an index of local collocation, 

$$ L = \frac{\sum_{1}^{n}{p_{1,i}}*p_{2,i}}{\sqrt{{\sum_{1}^{n}p_{1,i}^2}{\sum_{1}^{n}p_{2,i}^2}}}$$
which describes the correlation between two ranges. It ranges between 0 and 1 and can be thought of as the ratio of the probability of finding two species in the same area to the total probability of finding either species.

...and an index of global collocation, from Bez and Rivoirard (2000) and Carroll et al. (2019), measuring more regional-scale overlap by comparing centers of gravity and inertia/dispersion of each species' range.

```{r}
#Schoener's D
schoeners <- function(dat1, dat2) {
  p1 <- dat1$ens_est
  p2 <- dat2$ens_est
  p_p1 <- p1/sum(p1, na.rm = T)
  p_p2 <- p2/sum(p2, na.rm = T)
  1 - 0.5 * (sum(abs(p_p1-p_p2), na.rm = T))
}
```

```{r}
lic <- function(dat1,dat2) {
  p1 <- dat1$ens_est
  p2 <- dat2$ens_est
  p_p1 <- p1/sum(p1, na.rm = T)
  p_p2 <- p2/sum(p2, na.rm = T)
  sum(p_p1*p_p2, na.rm = T)/(sqrt(sum(p_p1^2, na.rm = T)*sum(p_p2^2, na.rm = T)))
}
```

```{r}
# Version from Gemma's 2019 paper
# glob_collocfn <- function(prey_x, prey_y, prey, pred_x, pred_y, pred){
#   prey_cgx <- sum(prey_x*prey, na.rm = T)/sum(prey, na.rm = T)
#   prey_cgy <- sum(prey_y*prey, na.rm = T)/sum(prey, na.rm = T)
#   prey_ix <- prey_x - prey_cgx
#   prey_iy <- prey_y - prey_cgy
#   prey_i <- sqrt(prey_ix^2 + prey_iy^2)
#   prey_inert <- sum(prey * (prey_i^2), na.rm = T)/sum(prey, na.rm = T)
#   pred_cgx <- sum(pred_x*pred, na.rm = T)/sum(pred, na.rm = T)
#   pred_cgy <- sum(pred_y*pred, na.rm = T)/sum(pred, na.rm = T)
#   pred_ix <- pred_x - pred_cgx
#   pred_iy <- pred_y - pred_cgy
#   pred_i <- sqrt(pred_ix^2 + pred_iy^2)
#   pred_inert <- sum(pred * (pred_i^2), na.rm = T)/sum(pred, na.rm = T)
#   GIC <- (((prey_cgx - pred_cgx)^2+(prey_cgy - pred_cgy)^2)/ (((prey_cgx-pred_cgx)^2+(prey_cgy-pred_cgy)^2)+prey_inert + pred_inert))
#   if(!is.na(GIC))
#     GIC <- 1-GIC
#   else GIC <- 1
#   GIC
# }

# Edited to use with COGS calculated from sdmTMB, for species k and j

gic <- function(dat1,dat2,cog1,cog2){
  k_x <- dat1$longitude
  k_y <- dat1$latitude
  k <- dat1$ens_est
  k_cogx <- cog1$w.est_x
  k_cogy <- cog1$w.est_y
  j_x <- dat2$longitude
  j_y <- dat2$latitude
  j <- dat2$ens_est
  j_cogx <- cog2$w.est_x
  j_cogy <- cog2$w.est_y
  
  k_ix <- k_x-k_cogx
  k_iy <- k_y-k_cogy
  k_i <- sqrt(k_ix^2+k_iy^2)
  k_inert <- sum(k*(k_i^2),na.rm=T)/sum(k,na.rm=T)
  
  j_ix <- j_x-j_cogx
  j_iy <- j_y-j_cogy
  j_i <- sqrt(j_ix^2+j_iy^2)
  j_inert <- sum(j*(j_i^2),na.rm=T)/sum(j,na.rm=T)
  
  GIC <- (((k_cogx - j_cogx)^2+(k_cogy - j_cogy)^2)/ (((k_cogx-j_cogx)^2+(k_cogy-j_cogy)^2)+k_inert + j_inert))
  if(!is.na(GIC))
    GIC <- 1-GIC
  else GIC <- 1
  GIC
}

```

```{r}
ens_est_overlaps <- dover_ens %>% nest(dover = c(longitude, latitude, lat, lon, depth_m, ens_est)) %>% 
  # join all the data and cogs nested by year
  left_join(sable_ens %>% nest(sable = c(longitude, latitude, lat, lon, depth_m, ens_est))) %>% 
  left_join(ls_ens %>% nest(ls = c(longitude, latitude, lat, lon, depth_m, ens_est))) %>% 
  left_join(dover_cog %>% nest(dover_cog=c(w.est_x,w.est_y)))%>% 
  left_join(sable_cog %>% nest(sable_cog=c(w.est_x,w.est_y)))%>% 
  left_join(ls_cog %>% nest(ls_cog=c(w.est_x,w.est_y))) %>% 
  # calculate the gic
  mutate(dover_sable_gic=purrr::pmap_dbl(list(dat1=dover,dat2=sable,cog1=dover_cog,cog2=sable_cog),gic)) %>% 
  mutate(dover_ls_gic=purrr::pmap_dbl(list(dat1=dover,dat2=ls,cog1=dover_cog,cog2=ls_cog),gic)) %>% 
  mutate(sable_ls_gic=purrr::pmap_dbl(list(dat1=sable,dat2=ls,cog1=sable_cog,cog2=ls_cog),gic)) %>% 
    # calculate Schoener's D
  mutate(dover_sable_sch=purrr::pmap_dbl(list(dat1=dover,dat2=sable),schoeners)) %>% 

  mutate(dover_ls_sch=purrr::pmap_dbl(list(dat1=dover,dat2=ls),schoeners)) %>% 
  mutate(sable_ls_sch=purrr::pmap_dbl(list(dat1=sable,dat2=ls),schoeners)) %>% 
  # calculate local colocation
  mutate(dover_sable_loc=purrr::pmap_dbl(list(dat1=dover,dat2=sable),lic)) %>% 

  mutate(dover_ls_loc=purrr::pmap_dbl(list(dat1=dover,dat2=ls),lic)) %>% 
  mutate(sable_ls_loc=purrr::pmap_dbl(list(dat1=sable,dat2=ls),lic))

```
## Local Index of Co-location

```{r}
ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_loc:sable_ls_loc) %>% 
  pivot_longer(dover_sable_loc:sable_ls_loc,values_to='loc') %>% 
  mutate(lab=case_when(
    name=="dover_sable_loc" ~ "Dover Sole/Sablefish",
    name=="dover_ls_loc" ~ "Dover Sole/Thornyhead",
    name=="sable_ls_loc" ~ "Sablefish/Thornyhead"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,loc,col=lab))+
  geom_line(size=1.5)+
  theme(legend.position=c(0.8,0.75),
        legend.background = element_rect(color='black'))+
  labs(x="Year",y="Index of Collocation",color="Species Pair")
```
## Global Index of Co-location

```{r}
ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_gic:sable_ls_gic) %>% 
  pivot_longer(dover_sable_gic:sable_ls_gic,values_to='gic') %>% 
  mutate(lab=case_when(
    name=="dover_sable_gic" ~ "Dover Sole/Sablefish",
    name=="dover_ls_gic" ~ "Dover Sole/Thornyhead",
    name=="sable_ls_gic" ~ "Sablefish/Thornyhead"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,gic,col=lab))+
  geom_line(size=1.5)+
  scale_y_continuous(limits = c(0,1))+
  theme(legend.position=c(0.8,0.75),
        legend.background = element_rect(color='black'))+
  labs(x="Year",y="Global Index of Collocation",color="Species Pair")
```

## Schoener's D

```{r}
ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_sch:sable_ls_sch) %>% 
  pivot_longer(dover_sable_sch:sable_ls_sch,values_to='sch') %>% 
  mutate(lab=case_when(
    name=="dover_sable_sch" ~ "Dover Sole/Sablefish",
    name=="dover_ls_sch" ~ "Dover Sole/Thornyhead",
    name=="sable_ls_sch" ~ "Sablefish/Thornyhead"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,sch,col=lab))+
  geom_line(size=1.5)+
  theme(legend.position=c(0.8,0.75),
        legend.background = element_rect(color='black'))+
  labs(x="Year",y="Schoener's D",color="Species Pair")
```

# Dover sole inter-model comparison

Index of abundance
IPSL vs. Hadley vs. GFDL

```{r}
dover_index_ipsl <- make_index(dover_models,gcm="ipsl")
dover_index_hadl <- make_index(dover_models,gcm="hadl")
dover_index_gfdl<- make_index(dover_models,gcm="gfdl")

dover_indices <- dover_index_ipsl$data %>% 
  rename(IPSL=w.est) %>% 
  left_join(dover_index_hadl$data %>% rename(Hadley=w.est)) %>% 
  left_join(dover_index_gfdl$data %>% rename(GFDL=w.est))
  
dover_indices %>% 
  filter(year>2020) %>% 
  pivot_longer(IPSL:GFDL,names_to="model",values_to='abun') %>% 
  ggplot(aes(x=year,abun/10000,col=model))+
  geom_line(size=1.5)+
  theme(legend.position=c(0.1,0.25),
        legend.background = element_rect(color='black'))+
  labs(x="Year",y="Ensemble Index of Abundance",color="Model")
```

## Env Affinities

Dover

```{r,fig.width=8,fig.height=3}
make_env(dover_models %>% pluck('model',1))
```


Sablefish
```{r,fig.width=8,fig.height=3}
make_env(sable_models %>% pluck('model',1))
```
Longspine
```{r,fig.width=8,fig.height=3}
make_env(ls_models %>% pluck('model',1))
```



## Comparison Maps

```{r}
sablemap1 <- make_comparison_map(sable_ens,yr=2050)
sablemap2 <- make_comparison_map(sable_ens,yr=2100)

lsmap1 <- make_comparison_map(ls_ens,yr=2050)
lsmap2 <- make_comparison_map(ls_ens,yr=2100)
```

# Overlapping Niche Space

```{r}
# combined ensemble abundance
three_spp <- dover_ens %>% rename(dover=ens_est) %>% 
  left_join(sable_ens %>% rename(sable=ens_est)) %>% 
  left_join(ls_ens %>% rename(longspine=ens_est)) %>% 
  # relative abundance
  mutate(across(dover:longspine, ~exp(.x))) %>% 
  mutate(across(dover:longspine, ~.x/max(.x))) %>% 
  # join roms data
  left_join(roms)

# temperature/oxygen biplot
# t_o_kobe <- three_spp %>% 
#   filter(year>1979,year<2021) %>% 
#   dplyr::select(dover:longspine,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>% 
#   pivot_longer(dover:longspine,names_to="species",values_to="rel_abun") %>% 
#   mutate(species=factor(species)) %>% 
#   ggplot(aes(x=mean_bt_30d_ipsl,y=mean_oxy_bottom_30d_ipsl,z=rel_abun,group=species))+
#   geom_contour_filled()+
#   labs(x="Temperature",y="Oxygen (mmol/m3)")
# t_o_kobe
# 
# three_spp %>% 
#   filter(year>1979,year<2021) %>% 
#   dplyr::select(dover:longspine,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>% 
#   pivot_longer(dover:longspine,names_to="species",values_to="rel_abun") %>% 
#   mutate(species=factor(species)) %>% 
#   ggplot(aes(mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl,z=rel_abun,group=species))+
#   geom_contour_filled()+
#   labs(x="Temperature",y="Oxygen (mmol/m3)")
```

