---
title: "DTS projection comparison"
author: "Owen Liu"
date: "9/29/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(magrittr)
library(lubridate)
library(rnaturalearth)
library(sf)
library(here)
library(viridis)
# vista is Eric Ward's library for looking at outputs
library(vista)
library(cowplot)
library(RANN)
library(furrr)
library(future)
library(tictoc)
library(ggsci)
library(ggpubr)

knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

```{r}
# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=12,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

Load functions and data used for models. This command sources code and data from the `sdmTMB model functions` and `sdmTMB data construction` scripts.

```{r}
rmarkdown::render(here::here('scripts','sdmTMB model functions.Rmd'),quiet=TRUE)
```

# Landings and Value

Plot landings and value of species over time.

```{r}
pal <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
landings_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T)) %>% 
  ggplot(aes(Year,tot_dollars/1e6,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Landings (Million $)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.1,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
```

# Map of Study Area

```{r}
bbox1 <- st_bbox(projection_extent)
study_area <- ggplot()+
  geom_sf(data=coast,fill='gray80')+
  geom_sf(data=projection_extent,fill='blue',alpha=0.5,col=NA)+
  coord_sf(datum=NA)+
  xlim(bbox1[1],bbox1[3])+ylim(bbox1[2],bbox1[4])
# study_area
```

# Mean Change in Conditions

Calculate and visualize the mean change in bottom temperature and oxygen for the study area, according to the ROMS-IPSL model.

```{r}
roms_bt_oxy_ts <- roms %>% 
  dplyr::select(year,latitude,longitude,contains('30d_ipsl')) %>% 
  group_by(year) %>% 
  summarise(bt=mean(mean_bt_30d_ipsl),
            oxy=mean(mean_oxy_bottom_30d_ipsl)) %>% 
  ungroup()
roms_bt_ts_plot <- roms_bt_oxy_ts %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,bt))+
  geom_line()+
  scale_x_continuous(expand=c(0,5))+
  labs(x="Year",y="Bottom Temperature")+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12))

roms_oxy_ts_plot <- roms_bt_oxy_ts %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,oxy))+
  geom_line()+
  scale_x_continuous(expand=c(0,5))+
  labs(x="Year",y="Bottom Oxygen")+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text = element_text(size=10),
        axis.title= element_text(size=12))

bt_oxy_ts_plot <- plot_grid(roms_bt_ts_plot,roms_oxy_ts_plot,nrow=2)
# bt_oxy_ts_plot
```

```{r,fig.height=8,fig.width=8}
brow <- plot_grid(study_area,bt_oxy_ts_plot,ncol=2,labels=c('b','c'),hjust=c(-2,0.3))
intro_plot <- plot_grid(landings_plot,brow,nrow=2,rel_heights = c(0.7,1),labels=c('a',''))
intro_plot

ggsave(here('model output','dts paper','landings_and_study_area.png'),intro_plot,h=8,w=8)
```


# Model Species

Use `sdmTMB` to make ensemble models for each species of interest. (if these models have already been run, can just load them rather than running them again)

```{r,eval=F}
spp_to_model <- c("dover sole","sablefish","shortspine thornyhead","longspine thornyhead")
```

Run models and save cross-validation model stacking weights. (note: this chunk is turned to eval=F for now)

```{r,eval=F}
for(i in 1:length(spp_to_model)){
  s <- spp_to_model[i]
  m <- model_species(s,data = trawl_roms_utm,use_substrate = F)
  write_rds(m,here::here('model output','dts paper',paste(s,'models.rds')))
  print(paste(s,'models finished'))
}
```

# Produce ensemble predictions for DTS

Use IPSL ESM for now

```{r,eval=F}
dover_models <- read_rds(here::here('model output','dover sole models.rds'))
sable_models <- read_rds(here::here('model output','sablefish models.rds'))
ss_models <- read_rds(here::here('model output','shortspine thornyhead models.rds'))
ls_models <- read_rds(here::here('model output','longspine thornyhead models.rds'))

dover_ens <- ensemble_predictions(dover_models,gcm='ipsl')
sable_ens <- ensemble_predictions(sable_models,gcm='ipsl')
ss_ens <- ensemble_predictions(ss_models,gcm="ipsl")
ls_ens <- ensemble_predictions(ls_models,gcm='ipsl')

write_rds(dover_ens,here('model output','dts paper','dover_ensemble_preds_ipsl.rds'))
write_rds(sable_ens,here('model output','dts paper','sable_ensemble_preds_ipsl.rds'))
write_rds(ss_ens,here('model output','dts paper','ss_ensemble_preds_ipsl.rds'))
write_rds(ls_ens,here('model output','dts paper','ls_ensemble_preds_ipsl.rds'))
```

```{r}
dover_ens <- read_rds(here('model output','dts paper','dover_ensemble_preds_ipsl.rds'))
sable_ens <- read_rds(here('model output','dts paper','sable_ensemble_preds_ipsl.rds'))
ss_ens<-read_rds(here('model output','dts paper','ss_ensemble_preds_ipsl.rds'))
ls_ens<-read_rds(here('model output','dts paper','ls_ensemble_preds_ipsl.rds'))
```


# Ensemble Abundance

```{r,eval=F}
doverind <- make_index(dover_models,gcm = 'ipsl')
sableind <- make_index(sable_models,gcm = 'ipsl')
ssind <- make_index(ss_models,gcm = 'ipsl')
lsind <- make_index(ls_models,gcm = 'ipsl')

# ggsave(here('model output','dts paper','dover_ensemble_index_ipsl.png'),doverind,h=6,w=8)
# ggsave(here('model output','dts paper','sable_ensemble_index_ipsl.png'),sableind,h=6,w=8)
# ggsave(here('model output','dts paper','shortspine_ensemble_index_ipsl.png'),ssind,h=6,w=8)
# ggsave(here('model output','dts paper','longspine_ensemble_index_ipsl.png'),lsind,h=6,w=8)
```

# Center of Gravity

```{r,eval=F}
dover_cog <- make_cog(dover_models,gcm = 'ipsl',what="dat")
sable_cog <- make_cog(sable_models,gcm = 'ipsl',what="dat")
ss_cog <- make_cog(ss_models,gcm = 'ipsl',what="dat")
ls_cog <- make_cog(ls_models,gcm = 'ipsl',what="dat")

write_rds(dover_cog,here('model output','dts paper','dover_cog_ipsl.rds'))
write_rds(sable_cog,here('model output','dts paper','sable_cog_ipsl.rds'))
write_rds(ss_cog,here('model output','dts paper','ss_cog_ipsl.rds'))
write_rds(ls_cog,here('model output','dts paper','ls_cog_ipsl.rds'))
```

```{r}
dover_cog <- read_rds(here('model output','dts paper','dover_cog_ipsl.rds'))
sable_cog <- read_rds(here('model output','dts paper','sable_cog_ipsl.rds'))
ss_cog <-read_rds(here('model output','dts paper','ss_cog_ipsl.rds'))
ls_cog <-read_rds(here('model output','dts paper','ls_cog_ipsl.rds'))
```

# Environmental Affinities

```{r}
# combined ensemble abundance
four_spp <- dover_ens %>% rename(dover=ens_est) %>% 
  left_join(sable_ens %>% rename(sable=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  left_join(ss_ens %>% rename(ss_thornyhead=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  left_join(ls_ens %>% rename(ls_thornyhead=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  # join roms data
  left_join(roms,by = c("year", "longitude", "latitude", "lat", "lon")) %>% 
  dplyr::select(year,dover:ls_thornyhead,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>%
  pivot_longer(dover:ls_thornyhead,names_to="species",values_to="ens_est")
```

Calculate and visualize environmental affinities of the four species.

```{r}
four_spp_sf <- four_spp %>%
      st_as_sf(coords=c("mean_bt_30d_ipsl","mean_oxy_bottom_30d_ipsl"))
tempr <- raster::raster(raster::extent(st_bbox(four_spp_sf)),nrows=150,ncol=100)
```

```{r,fig.height=4,fig.width=8}
four_spp_r <- four_spp %>% 
  filter(year>=1980,year<=2010) %>% 
  group_split(species) %>% 
  purrr::map(rasterize_affinities,template_raster=tempr) %>% 
  set_names(unique(four_spp$species))

ylab <- text_grob("Oxygen",rot=90)
xlab <- text_grob("Temperature",just = "center")
leg <- four_spp %>% filter(species=="dover") %>% rasterize_affinities(template_raster=tempr,return_what="legend")
xrow <- plot_grid(NULL,NULL,xlab,NULL,nrow=1,rel_widths=c(0.1,1,1,1))
  
four_spp_affinities <-plot_grid(plotlist = list(ylab,four_spp_r[[1]],four_spp_r[[2]],NULL,four_spp_r[[3]],four_spp_r[[4]],leg,NULL,NULL,NULL,xlab,NULL,NULL),nrow=2,ncol=7,rel_widths=c(0.1,1,1,0.1,1,1,0.5),rel_heights = c(1,0.1),labels = c("","a","b","","c","d",""))

four_spp_affinities
ggsave(here('model output','dts paper','four species affinities.png'),four_spp_affinities,w=8,h=4)
```

# Depth Change

```{r,fig.height=8,fig.width=8}
doverdepth <- plot_depth_distribution(dover_ens,name="Dover Sole")
sabledepth <- plot_depth_distribution(sable_ens,name="Sablefish")
ssdepth <- plot_depth_distribution(ss_ens,name="Shortspine")
lsdepth <- plot_depth_distribution(ls_ens,name="Longspine")
four_spp_depths <- plot_grid(doverdepth,sabledepth,ssdepth,lsdepth,nrow=2,labels="auto")

# add fishy icons
plt <- ggdraw()+
  draw_plot(four_spp_depths)+
  draw_image(here('data','icons','dover1.jpg'),hjust=.28,vjust=-.2,scale=0.2)+
  draw_image(here('data','icons','sablefish.png'),hjust=-.2,vjust=-.2,scale=0.2)+
  draw_image(here('data','icons','shortspine.png'),hjust=.28,vjust=.3,scale=0.2)+
  draw_image(here('data','icons','longspine1.jpg'),hjust=-.23,vjust=.3,scale=0.2)
plt

ggsave(here('model output','dts paper','four species depth distribution.png'),plt,w=8,h=8)
```

# Distance from Shore

Weighted distance from shore

```{r,fig.width=8,fig.height=6}
dover_dist <- plot_dist_to_shore(dover_ens,include_legend = F)
sable_dist <- plot_dist_to_shore(sable_ens,include_legend = F)
ss_dist <- plot_dist_to_shore(ss_ens,include_legend = F)
ls_dist <- plot_dist_to_shore(ls_ens,include_legend = F)

ylab <- text_grob("Latitude",rot=90)
xlab <- text_grob("Centroid Distance from Shore (km)",vjust = -2)
distleg <- dover_ens %>% plot_dist_to_shore(include_legend=T) %>% ggpubr::get_legend()


four_spp_dist <- plot_grid(ylab,dover_dist,sable_dist,NULL,ss_dist,ls_dist,distleg,NULL,NULL,NULL,xlab,NULL,NULL,NULL,ncol=7,
                           labels=c("",'a',"b","","c","d",""),
                           rel_widths = c(0.1,1,1,0.1,1,1,0.5),
                           rel_heights = c(1,0.1))
four_spp_dist
ggsave(here('model output','dts paper','four species distance from shore.png'),four_spp_dist,w=8,h=6)
```

```{r,fig.width=8,fig.height=6}
dover_distmap <- map_dist_to_shore(dover_ens,include_legend = F)
sable_distmap <- map_dist_to_shore(sable_ens,include_legend = F)
ss_distmap <- map_dist_to_shore(ss_ens,include_legend = F)
ls_distmap <- map_dist_to_shore(ls_ens,include_legend = F)

ylab <- text_grob("Latitude",rot=90)
xlab <- text_grob("Distribution Centroid",vjust = -5)
distmapleg <- dover_ens %>% map_dist_to_shore(include_legend=T) %>% ggpubr::get_legend()


four_spp_distmap <- plot_grid(ylab,dover_distmap,sable_distmap,NULL,ss_distmap,ls_distmap,distmapleg,NULL,NULL,NULL,xlab,NULL,NULL,NULL,ncol=7,
                           labels=c("",'a',"b","","c","d",""),
                           rel_widths = c(0.1,1,1,0.1,1,1,0.5),
                           rel_heights = c(1,0.05))
four_spp_distmap
ggsave(here('model output','dts paper','four species distance from shore map.png'),four_spp_distmap,w=8,h=6)
```

# Hovmoller Plots

As another way to show the expected changes in depth and abundance across space, show Hovmoller-type plots

```{r,fig.height=6,fig.width=8}
dover_hov <- make_hov(dover_models,gcm="ipsl")
sable_hov <- make_hov(sable_models,gcm="ipsl")
ss_hov <- make_hov(ss_models,gcm="ipsl")
ls_hov <- make_hov(ls_models,gcm="ipsl")

dover_hov
sable_hov
ss_hov
ls_hov

ggsave(here('model output','dts paper','dover sole hovmoller.png'),dover_hov,w=8,h=6)
ggsave(here('model output','dts paper','sablefish hovmoller.png'),sable_hov,w=8,h=6)
ggsave(here('model output','dts paper','shortspine hovmoller.png'),ss_hov,w=8,h=6)
ggsave(here('model output','dts paper','longspine hovmoller.png'),ls_hov,w=8,h=6)
```


# Maps

```{r,fig.height=10,fig.width=7}
dover2021_map <- map_year(dover_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
sable2021_map <- map_year(sable_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
ss2021_map <- map_year(ss_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
ls2021_map <- map_year(ls_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)

plot_grid(dover2021_map,sable2021_map,ss2021_map,ls2021_map,nrow=2,labels='auto')

dover2100_map <- map_year(dover_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
sable2100_map <- map_year(sable_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
ss2100_map <- map_year(ss_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
ls2100_map <- map_year(ls_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
plot_grid(dover2100_map,sable2100_map,ss2100_map,ls2100_map,nrow=2,labels='auto')
```

# Calculate Overlap Over Time

Schoener's D measures spatial niche overlap, or how two species use space relative to its availability.

$$D = 1 - 0.5*\sum_{1}^{n}{|p_{1,i}-p_{2,i}|}$$


Also calculating an index of local collocation, 

$$ L = \frac{\sum_{1}^{n}{p_{1,i}}*p_{2,i}}{\sqrt{{\sum_{1}^{n}p_{1,i}^2}{\sum_{1}^{n}p_{2,i}^2}}}$$
which describes the correlation between two ranges. It ranges between 0 and 1 and can be thought of as the ratio of the probability of finding two species in the same area to the total probability of finding either species.

...and an index of global collocation, from Bez and Rivoirard (2000) and Carroll et al. (2019), measuring more regional-scale overlap by comparing centers of gravity and inertia/dispersion of each species' range.

```{r}
ens_est_overlaps <- dover_ens %>% nest(dover = c(longitude, latitude, lat, lon, depth_m, ens_est)) %>% 
  # join all the data and cogs nested by year
  left_join(sable_ens %>% nest(sable = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(ss_ens %>% nest(ss = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(ls_ens %>% nest(ls = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(dover_cog %>% nest(dover_cog=c(w.est_x,w.est_y)),by = "year")%>% 
  left_join(sable_cog %>% nest(sable_cog=c(w.est_x,w.est_y)),by = "year")%>% 
  left_join(ss_cog %>% nest(ss_cog=c(w.est_x,w.est_y)),by = "year") %>%  
  left_join(ls_cog %>% nest(ls_cog=c(w.est_x,w.est_y)),by = "year") %>% 
  
  # calculate the gic
  mutate(dover_sable_gic=purrr::pmap_dbl(list(dat1=dover,dat2=sable,cog1=dover_cog,cog2=sable_cog),gic)) %>%
  mutate(dover_ss_gic=purrr::pmap_dbl(list(dat1=dover,dat2=ss,cog1=dover_cog,cog2=ss_cog),gic)) %>% 
  mutate(dover_ls_gic=purrr::pmap_dbl(list(dat1=dover,dat2=ls,cog1=dover_cog,cog2=ls_cog),gic)) %>% 
  mutate(sable_ss_gic=purrr::pmap_dbl(list(dat1=sable,dat2=ss,cog1=sable_cog,cog2=ss_cog),gic)) %>% 
  mutate(sable_ls_gic=purrr::pmap_dbl(list(dat1=sable,dat2=ls,cog1=sable_cog,cog2=ls_cog),gic)) %>% 
  mutate(ss_ls_gic=purrr::pmap_dbl(list(dat1=ss,dat2=ls,cog1=ss_cog,cog2=ls_cog),gic)) %>% 
  
  # calculate Schoener's D
  mutate(dover_sable_sch=purrr::pmap_dbl(list(dat1=dover,dat2=sable),schoeners)) %>% 
  mutate(dover_ss_sch=purrr::pmap_dbl(list(dat1=dover,dat2=ss),schoeners)) %>% 
  mutate(dover_ls_sch=purrr::pmap_dbl(list(dat1=dover,dat2=ls),schoeners)) %>% 
  mutate(sable_ss_sch=purrr::pmap_dbl(list(dat1=sable,dat2=ss),schoeners)) %>% 
  mutate(sable_ls_sch=purrr::pmap_dbl(list(dat1=sable,dat2=ls),schoeners)) %>% 
  mutate(ss_ls_sch=purrr::pmap_dbl(list(dat1=ss,dat2=ls),schoeners)) %>% 
  
  # calculate local colocation
  mutate(dover_sable_loc=purrr::pmap_dbl(list(dat1=dover,dat2=sable),lic)) %>% 
  mutate(dover_ss_loc=purrr::pmap_dbl(list(dat1=dover,dat2=ss),lic)) %>% 
  mutate(dover_ls_loc=purrr::pmap_dbl(list(dat1=dover,dat2=ls),lic)) %>%
  mutate(sable_ss_loc=purrr::pmap_dbl(list(dat1=sable,dat2=ss),lic)) %>%  
  mutate(sable_ls_loc=purrr::pmap_dbl(list(dat1=sable,dat2=ls),lic)) %>% 
  mutate(ss_ls_loc=purrr::pmap_dbl(list(dat1=ss,dat2=ls),lic))

```

## Local Index of Co-location

```{r}
lic_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_loc:ss_ls_loc) %>% 
  pivot_longer(dover_sable_loc:ss_ls_loc,values_to='loc') %>% 
  mutate(lab=case_when(
    name=="dover_sable_loc" ~ "Dover Sole/Sablefish",
    name=="dover_ss_loc" ~ "Dover Sole/Shortspine",
    name=="dover_ls_loc" ~ "Dover Sole/Longspine",
    name=="sable_ss_loc" ~ "Sablefish/Shortspine",
    name=="sable_ls_loc" ~ "Sablefish/Longspine",
    name=="ss_ls_loc" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,loc,col=lab))+
  geom_line(size=1)+
  scale_y_continuous(limits=c(NA,1))+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  theme(legend.background = element_rect(color='black'),
        legend.text = element_text(size=12))+
  labs(x="Year",y="Local Index of Collocation",color="Species Pair")
lic_plot
ggsave(here('model output','dts paper','four species LIC.png'),lic_plot,w=8,h=6)
```
## Global Index of Co-location

```{r}
gic_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_gic:ss_ls_gic) %>% 
  pivot_longer(dover_sable_gic:ss_ls_gic,values_to='gic') %>% 
  mutate(lab=case_when(
    name=="dover_sable_gic" ~ "Dover Sole/Sablefish",
    name=="dover_ss_gic" ~ "Dover Sole/Shortspine",
    name=="dover_ls_gic" ~ "Dover Sole/Longspine",
    name=="sable_ss_gic" ~ "Sablefish/Shortspine",
    name=="sable_ls_gic" ~ "Sablefish/Longspine",
    name=="ss_ls_gic" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,gic,col=lab))+
  geom_line(size=1)+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  scale_y_continuous(limits = c(0.8,1))+
  theme(legend.background = element_rect(color='black'))+
  labs(x="Year",y="Global Index of Collocation",color="Species Pair")
gic_plot

ggsave(here('model output','dts paper','four species GIC.png'),gic_plot,w=8,h=6)
```

## Schoener's D

```{r}
D_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_sch:ss_ls_sch) %>% 
  pivot_longer(dover_sable_sch:ss_ls_sch,values_to='sch') %>% 
  mutate(lab=case_when(
    name=="dover_sable_sch" ~ "Dover Sole/Sablefish",
    name=="dover_ss_sch" ~ "Dover Sole/Shortspine",
    name=="dover_ls_sch" ~ "Dover Sole/Longspine",
    name=="sable_ss_sch" ~ "Sablefish/Shortspine",
    name=="sable_ls_sch" ~ "Sablefish/Longspine",
    name=="ss_ls_sch" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,sch,col=lab))+
  geom_line(size=1)+
  scale_y_continuous(limits=c(NA,1))+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  theme(legend.background = element_rect(color='black'))+
  labs(x="Year",y="Schoener's D",color="Species Pair")

D_plot

ggsave(here('model output','dts paper','four species D.png'),D_plot,w=8,h=6)
```

## All Together

```{r,fig.width=8,fig.height=8}
overlap_legend <- get_legend(lic_plot)
lic_noleg <- lic_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')
gic_noleg <- gic_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')
D_noleg <- D_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')

overlap_plots <- plot_grid(gic_noleg,lic_noleg,D_noleg,overlap_legend,nrow=2,labels=c('a','b','c',''))
overlap_plots
ggsave(here('model output','dts paper','species_overlap_metrics.png'),overlap_plots,w=8,h=8)
```

# DTS Footprints

We can use fishing data to look at climatic and predicted species abundance and overlap changes within historical (2011-2015) fishing footprints for DTS. From Becca Selden, 12/09/2021:

Communities were defined as all trips returning to a specific IOPAC port group. All fishing trips associated with the community that caught dover sole, thornyhead, and sablefish were extracted from PACFIN. Total quantity landed was aggregated across species for each trip. The latitude and longitude coordinates were converted to the Mercator projection UTM Zone 10 to allow for more accurate estimates of area and overlap. A weighted kernel density surface was created from the point estimates of catch for the focal period with a 10 km bandwidth, using the density.ppp function in the sp package in R. The footprint of the community was defined using a percent volume contour that represents the boundary of the area that contains 75% of the volume of the kernel density distribution using the `getvolumeUD` function in the `adehabitat` package in R.

## Predicted Species Abundance

Using sdmTMB ensemble model outputs, calculate changing mean species densities within DTS footprints.

```{r}
bbox=st_bbox(footprints)
footprints_map <- ggplot()+
  geom_sf(data=footprints,aes(fill=port_name),alpha=0.5)+
  geom_sf(data=coast,fill='gray80')+
  geom_sf(data=port_coords,aes(color=port_name),size=3)+
  scale_fill_npg()+
  scale_color_npg()+
  guides(color="none")+
  coord_sf(datum=NA)+
  labs(fill="Port")+
  xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])
footprints_map
```


### Mean CPUE Time Series

Calculate the mean CPUE and mean CPUE change within each footprint, for each species, over time

```{r,fig.height=6,fig.width=}
footprint_ts <- purrr::map2_df(list(dover_ens,sable_ens,ss_ens,ls_ens),c("Dover Sole","Sablefish","Shortspine","Longspine"),function(x,y)calc_footprint_dens_ts(x,what="df") %>% mutate(species=y)) %>% 
  mutate(species=factor(species,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

pal4 <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
footprint_ts_plot <- footprint_ts %>% 
  ggplot(aes(year,mean_cpue,col=species))+
  geom_line(size=1)+
  labs(x="Year",y="Log CPUE (kg per sq. km)",color="Species")+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,0))+
  facet_wrap(~port_name,ncol=1,scales='free_y')+
  theme(legend.position = "left",
        axis.text=element_text(size=10),
        panel.border = element_rect(color='black',fill=NA))
footprint_ts_plot

ggsave(here('model output','dts paper','footprint_cpue_ts.png'),footprint_ts_plot,w=8,h=6)
```

```{r}
footprint_reldens_ts<-purrr::map2_df(list(dover_ens,sable_ens,ss_ens,ls_ens),c("Dover Sole","Sablefish","Shortspine","Longspine"),function(x,y)calc_footprint_reldens_ts(x,what="df") %>% mutate(species=y)) %>% 
  mutate(species=factor(species,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

footprint_reldens_ts_plot <- footprint_reldens_ts %>% 
  ggplot(aes(year,perc_change,col=species))+
  geom_line(size=1)+
  # ggplot(aes(year,perc_change,col=species,size=mean_cpue/5500*3))+
  # geom_line()+
  geom_hline(yintercept=0,col='black')+
  labs(x="Year",y="Mean CPUE Change Relative to 2020 (%)",color="Species")+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,0))+
  facet_wrap(~port_name,ncol=1,scales='free_y')+
  theme(legend.position = "left",
        axis.text=element_text(size=10),
        panel.border = element_rect(color='black',fill=NA))
footprint_reldens_ts_plot

ggsave(here('model output','dts paper','footprint_rel_cpue_ts.png'),footprint_reldens_ts_plot,w=6,h=8)
```

```{r}
footprint_ts_plot_with_map <- plot_grid(footprint_reldens_ts_plot,footprints_map,ncol=2)
footprint_ts_plot_with_map
ggsave(here('model output','dts paper','footprints_cpue_ts_map.png'),footprint_ts_plot_with_map,h=8,w=8)
```

### LIC Time Series

Calculate the total (sum) local index of collocation within footprints, over time.

```{r}
dover_sable_lic_footprints <- calc_footprint_overlap_ts(dover_ens,sable_ens)

pal6 <- viridis_pal(option="A",begin=0.2,end=0.8)(6)
dover_sable_lic_footprints_plot <- dover_sable_lic_footprints %>% 
  ggplot(aes(year,sum_lic,color=port_name))+
  geom_line(size=1)+
  scale_color_npg()+
  labs(x="Year",y="Local Index of Collocation",col="Port")

dover_sable_lic_footprints_plot
```

