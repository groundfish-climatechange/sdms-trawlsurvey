---
title: "Run sdmTMB"
author: "Owen Liu"
date: "6/8/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(lubridate)
library(sf)
library(here)
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)

# for parallel processing
library(future)
plan(multisession)
```

# Purpose

Using sdmTMB, fit models for west coast groundfish based on hindcast ROMS oceanographic data.

# Data and Functions

Source `sdmTMB data and functions.Rmd` which has the data and functions required to run these models.

```{r, message=F, echo=F, include=F}
rmarkdown::render(here::here('scripts','sdmTMB data and functions.Rmd'),quiet=TRUE)
```


# Run the Models

Using the functions in the above script, run some sdmTMB models, while varying the species and wiggliness of relationships between the species and physical habitats (substrate, temperature, and bottom oxygen).

For each species, we run 8 models, and also perform 2-fold cross-validation to obtain a measure of model fit.

## Set Up Models

For each species, we set up the 8 models, then run them. We then run cross-validation and save the total (sum) log-likelihood of the witheld test set.

```{r}
model_species <- function(spp){
  models_to_run <- crossing(spp,spatial_field=c(F,T),hab_spline=c(F,T),env_spline=c(F,T)) %>%
    mutate(model_num=row_number())
  out <- models_to_run %>% 
    mutate(model=purrr::pmap(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB,dat=trawl_roms_utm)) %>%
    mutate(model_cv=purrr::pmap(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB_cv,dat=trawl_roms_utm,return_what="model"))
  
  model_weights <- try(sdmTMB_stacking(out$model_cv))
  if(class(model_weights)=='try-error'){
    print(paste('Error in model stacking.'))
    out$weight=NA
  } else{
    out$weight=model_weights
  }
    # mutate(stack_weight=sdmTMB_stacking(model_cv))
    # fit the models 
    # find the log likelihood
    # mutate(loglik=purrr::pmap_dbl(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB_cv,dat=trawl_roms_utm)) %>% 
    # # assign a relative model weight
    # mutate(model_weight=1/(loglik/max(loglik)))
  out
}
```

Test it out
```{r, eval=F}
test_models <- model_species('longspine thornyhead')
# glimpse(shortspine_models)
# sdmTMB_models <- crossing(spp=c("sablefish", "shortspine thornyhead","darkblotched rockfish","canary rockfish"),spatial_field=c(F,T),hab_spline=c(F,T),env_spline=c(F,T)) %>%
#   mutate(model_num=row_number())
# sdmTMB_models
```


## Call sdmTMB

Here we actually run the models, for a vector of species.

```{r}
# top 10 species by mean cpue in the trawl survey (this is a totally random criterion)
species <- trawl_roms_utm %>% 
  filter(species != "pacific hake",species != "dungeness crab") %>% 
  dplyr::group_by(species) %>% 
  summarise(meancpue=mean(cpue_kg_km2,na.rm=T)) %>% 
  ungroup() %>%
  slice_max(order_by = meancpue,n=10)
species
```

Run models and save cross-validation model stacking weights

```{r}

```

```{r}
plan(multisession)
for(i in 1:length(species$species)){
  s <- species$species[i]
  m <- model_species(s)
  write_rds(m,here::here('model output',paste(s,'models.rds')))
  print(paste(s,'models finished'))
}
```


```{r}
# OLD CODE
# sdmTMB_models <- sdmTMB_models %>% 
#   mutate(model=purrr::pmap(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB,dat=trawl_roms_utm))
# 
# #test model
# test_model <- sdmTMB_models %>% 
#   slice(6) %>% 
#   mutate(model=purrr::pmap(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB,dat=trawl_roms_utm))
```

Save model outputs as an .rds

```{r}
write_rds(sdmTMB_models,here::here('model output','four species sdmTMB test.rds'))
```


# Outputs

A list of the model fits, split by species.

```{r}
outputs <- sdmTMB_models %>% 
  group_split(spp) %>% 
  set_names(c('canary rockfish','darkblotched rockfish','sablefish','shortspine thornyhead'))
```

## Canary

```{r}
outputs %>% pluck('canary rockfish','model')
```

## Darkblotched

```{r}
outputs %>% pluck('darkblotched rockfish','model')
```

## Sablefish

```{r}
outputs %>% pluck('sablefish','model')
```

## Shortspine Thornyhead

```{r}
outputs %>% pluck('shortspine thornyhead','model')
```

