---
title: "Run sdmTMB"
author: "Owen Liu"
date: "6/8/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(lubridate)
library(sf)
library(here)
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

# Purpose

Using sdmTMB, fit models for west coast groundfish based on hindcast ROMS oceanographic data.

# Data and Functions

Source `sdmTMB data and functions.Rmd` which has the data and functions required to run these models.

```{r, message=F, echo=F, include=F}
rmarkdown::render(here::here('scripts','sdmTMB data and functions.Rmd'),quiet=TRUE)
```


# Run the Models

Using the functions in the above script, run some sdmTMB models, while varying the species and wiggliness of relationships between the species and physical habitats (substrate, temperature, and bottom oxygen).

## Set Up Model Table

We start with four species: sablefish, shortspine thornyhead, darkblotched rockfish, and (trying) canary rockfish

```{r}
sdmTMB_models <- crossing(spp=c("sablefish", "shortspine thornyhead","darkblotched rockfish","canary rockfish"),spatial_field=c(F,T),hab_spline=c(F,T),env_spline=c(F,T)) %>%
  mutate(model_num=row_number())
sdmTMB_models
```

## Call sdmTMB

Here we actually run the models.

```{r}
sdmTMB_models <- sdmTMB_models %>% 
  mutate(model=purrr::pmap(list(spp=spp,spatial_field=spatial_field,hab_spline=hab_spline,env_spline=env_spline),run_sdmTMB,dat=trawl_roms_utm))
```

Save model outputs as an .rds

```{r}
write_rds(sdmTMB_models,here::here('model output','four species sdmTMB test.rds'))
```


# Outputs

A list of the model fits, split by species.

```{r}
outputs <- sdmTMB_models %>% 
  group_split(spp) %>% 
  set_names(c('canary rockfish','darkblotched rockfish','sablefish','shortspine thornyhead'))
```

## Canary

```{r}
outputs %>% pluck('canary rockfish','model')
```

## Darkblotched

```{r}
outputs %>% pluck('darkblotched rockfish','model')
```

## Sablefish

```{r}
outputs %>% pluck('sablefish','model')
```

## Shortspine Thornyhead

```{r}
outputs %>% pluck('shortspine thornyhead','model')
```

