---
title: "Climate change effects on future groundfish availability to U.S. west coast fishing ports"
author: "Owen Liu"
date: '2022-07-05'
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(magrittr)
library(lubridate)
library(rnaturalearth)
library(sf)
library(here)
library(viridis)
# vista is Eric Ward's library for looking at outputs
library(vista)
library(cowplot)
library(ggalt)
library(RANN)
library(furrr)
library(future)
library(tictoc)
library(ggsci)
library(ggpubr)

knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

```{r}
# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=12,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
pal <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
pal4 <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
pal6 <- viridis_pal(option="C",begin=0.2,end=0.8)(6)
pal6_2 <- viridis_pal(option="B",begin=0.2,end=0.8)(6)
```

Load functions and data used for models. This command sources code and data from the `sdmTMB model functions` and `sdmTMB data construction` scripts.

```{r}
rmarkdown::render(here::here('scripts','sdmTMB-model-functions.Rmd'),quiet=TRUE)
```

# Model Species

Use `sdmTMB` to make ensemble models for each species of interest. (if these models have already been run, can just load them rather than running them again)

```{r,eval=F}
spp_to_model <- c("dover sole","sablefish","shortspine thornyhead","longspine thornyhead")
```

Run models and save cross-validation model stacking weights. (note: this chunk is turned to eval=F for now)

## Fit Models

```{r,eval=F}
for(i in 1:length(spp_to_model)){
  s <- spp_to_model[i]
  m <- model_species(s,data = trawl_roms_utm,use_substrate = F)
  write_rds(m,here::here('model output','dts paper',paste(s,'models.rds')))
  print(paste(s,'models finished'))
}
```

## Make Ensemble Predictions

We project across all 3 ESMs, weighting each equally

```{r,eval=T}
dover_models <- read_rds(here::here('model output','dts paper','dover sole models.rds'))
sable_models <- read_rds(here::here('model output','dts paper','sablefish models.rds'))
ss_models <- read_rds(here::here('model output','dts paper','shortspine thornyhead models.rds'))
ls_models <- read_rds(here::here('model output','dts paper','longspine thornyhead models.rds'))
```

IPSL
```{r,eval=F}
dover_ens_ipsl <- ensemble_predictions(dover_models,gcm='ipsl',nsims=100)
sable_ens_ipsl <- ensemble_predictions(sable_models,gcm='ipsl',nsims=100)
ss_ens_ipsl <- ensemble_predictions(ss_models,gcm="ipsl",nsims=100)
ls_ens_ipsl <- ensemble_predictions(ls_models,gcm='ipsl',nsims=100)

write_rds(dover_ens_ipsl,here('model output','dts paper','dover_ensemble_preds_ipsl.rds'))
write_rds(sable_ens_ipsl,here('model output','dts paper','sable_ensemble_preds_ipsl.rds'))
write_rds(ss_ens_ipsl,here('model output','dts paper','ss_ensemble_preds_ipsl.rds'))
write_rds(ls_ens_ipsl,here('model output','dts paper','ls_ensemble_preds_ipsl.rds'))
```

GFDL
```{r,eval=F}
dover_ens_gfdl <- ensemble_predictions(dover_models,gcm='gfdl',nsims=100)
sable_ens_gfdl <- ensemble_predictions(sable_models,gcm='gfdl',nsims=100)
ss_ens_gfdl <- ensemble_predictions(ss_models,gcm="gfdl",nsims=100)
ls_ens_gfdl <- ensemble_predictions(ls_models,gcm='gfdl',nsims=100)

write_rds(dover_ens_gfdl,here('model output','dts paper','dover_ensemble_preds_gfdl.rds'))
write_rds(sable_ens_gfdl,here('model output','dts paper','sable_ensemble_preds_gfdl.rds'))
write_rds(ss_ens_gfdl,here('model output','dts paper','ss_ensemble_preds_gfdl.rds'))
write_rds(ls_ens_gfdl,here('model output','dts paper','ls_ensemble_preds_gfdl.rds'))
```

Hadley
```{r,eval=F}
dover_ens_hadl <- ensemble_predictions(dover_models,gcm='hadl',nsims=100)
sable_ens_hadl <- ensemble_predictions(sable_models,gcm='hadl',nsims=100)
ss_ens_hadl <- ensemble_predictions(ss_models,gcm="hadl",nsims=100)
ls_ens_hadl <- ensemble_predictions(ls_models,gcm='hadl',nsims=100)

write_rds(dover_ens_hadl,here('model output','dts paper','dover_ensemble_preds_hadl.rds'))
write_rds(sable_ens_hadl,here('model output','dts paper','sable_ensemble_preds_hadl.rds'))
write_rds(ss_ens_hadl,here('model output','dts paper','ss_ensemble_preds_hadl.rds'))
write_rds(ls_ens_hadl,here('model output','dts paper','ls_ensemble_preds_hadl.rds'))
```

### Join 3 ESM Predictions

```{r,eval=F}
dover_ens_sims <-list(dover_ens_gfdl,dover_ens_ipsl,dover_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='dover')

sable_ens_sims <-list(sable_ens_gfdl,sable_ens_ipsl,sable_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='sable')

ss_ens_sims <-list(ss_ens_gfdl,ss_ens_ipsl,ss_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='ss')

ls_ens_sims <-list(ls_ens_gfdl,ls_ens_ipsl,ls_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='ls')

write_rds(sable_ens_sims,here('model output','dts paper','sable_ensemble_all_sims.rds'))
write_rds(dover_ens_sims,here('model output','dts paper','dover_ensemble_all_sims.rds'))
write_rds(ss_ens_sims,here('model output','dts paper','ss_ensemble_all_sims.rds'))
write_rds(ls_ens_sims,here('model output','dts paper','ls_ensemble_all_sims.rds'))
```

```{r,eval=F}
dover_ens_all <- purrr::map_df(list(dover_ens_gfdl,dover_ens_ipsl,dover_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

sable_ens_all <- purrr::map_df(list(sable_ens_gfdl,sable_ens_ipsl,sable_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

ss_ens_all <- purrr::map_df(list(ss_ens_gfdl,ss_ens_ipsl,ss_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

ls_ens_all <- purrr::map_df(list(ls_ens_gfdl,ls_ens_ipsl,ls_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

write_rds(sable_ens_all,here('model output','dts paper','sable_ensemble_preds_combined.rds'))
write_rds(dover_ens_all,here('model output','dts paper','dover_ensemble_preds_combined.rds'))
write_rds(ss_ens_all,here('model output','dts paper','ss_ensemble_preds_combined.rds'))
write_rds(ls_ens_all,here('model output','dts paper','ls_ensemble_preds_combined.rds'))
```

### Load

```{r}
# separate projections, with sims
dover_ens_separate <- list.files(here('model output','dts paper'),full.names = T) %>% str_subset('dover_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
sable_ens_separate <- list.files(here('model output','dts paper'),full.names = T) %>%
  str_subset('sable_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
ss_ens_separate <- list.files(here('model output','dts paper'),full.names = T) %>%
  str_subset('ss_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
ls_ens_separate <- list.files(here('model output','dts paper'),full.names = T) %>%
  str_subset('ls_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)

# combined across ESMs
dover_ens_all <- read_rds(here('model output','dts paper','dover_ensemble_preds_combined.rds')) %>% 
  mutate(species='dover')
  # rename(dover_median=median_est,dover_lower=est5,dover_upper=est95)
sable_ens_all <- read_rds(here('model output','dts paper','sable_ensemble_preds_combined.rds'))%>% 
  mutate(species='sable')
  # rename(sable_median=median_est,sable_lower=est5,sable_upper=est95)
ss_ens_all <- read_rds(here('model output','dts paper','ss_ensemble_preds_combined.rds'))%>% 
  mutate(species='ss')
  # rename(ss_median=median_est,ss_lower=est5,ss_upper=est95)
ls_ens_all <- read_rds(here('model output','dts paper','ls_ensemble_preds_combined.rds'))%>% 
  mutate(species='ls')
  # rename(ls_median=median_est,ls_lower=est5,ls_upper=est95)

# with sims
dover_ens_sims <- read_rds(here('model output','dts paper','dover_ensemble_all_sims.rds'))
sable_ens_sims <- read_rds(here('model output','dts paper','sable_ensemble_all_sims.rds'))
ss_ens_sims <- read_rds(here('model output','dts paper','ss_ensemble_all_sims.rds'))
ls_ens_sims <- read_rds(here('model output','dts paper','ls_ensemble_all_sims.rds'))

# Join. We need the data in slightly different forms for different analyses
# separate ESMs
four_spp_list <- list("dover"=dover_ens_separate,
                      "sable"=sable_ens_separate,
                      "ss"=ss_ens_separate,
                      "ls"=ls_ens_separate)
# combined ensemble abundance
four_spp <- list(dover_ens_all,sable_ens_all,ss_ens_all,ls_ens_all) %>% bind_rows() %>% 
  # join roms data
  left_join(roms,by = c("year", "longitude", "latitude", "lat", "lon"))

# with separate sims
# four_spp_sims <- list(dover_ens_sims,sable_ens_sims,ss_ens_sims,ls_ens_sims) %>% bind_rows() %>% 
#   # add summary columns
#   mutate(mean_est=purrr::map_dbl(data,mean),
#          est5=purrr::map_dbl(data,quantile,probs=0.05),
#          est95=purrr::map_dbl(data,quantile,probs=0.95))
```

## Model Fit Visualization

### Model Tables

```{r}
dover_fit_table <- report_model_ensemble(dover_models)
sable_fit_table <- report_model_ensemble(sable_models)
ss_fit_table <- report_model_ensemble(ss_models)
ls_fit_table <- report_model_ensemble(ls_models)
write_csv(dover_fit_table,here('model output','dts paper','dover_fit_table.csv'))
write_csv(sable_fit_table,here('model output','dts paper','sable_fit_table.csv'))
write_csv(ss_fit_table,here('model output','dts paper','ss_fit_table.csv'))
write_csv(ls_fit_table,here('model output','dts paper','ls_fit_table.csv'))
```

### QQ plots

```{r}
doverqq = make_qq_plots(dover_models)
sableqq = make_qq_plots(sable_models)
ssqq = make_qq_plots(ss_models)
lsqq = make_qq_plots(ls_models)
ggsave(here('model output','dts paper','dover_qq.png'),doverqq,h=3,w=8)
ggsave(here('model output','dts paper','sable_qq.png'),sableqq,h=3,w=8)
ggsave(here('model output','dts paper','ss_qq.png'),ssqq,h=3,w=8)
ggsave(here('model output','dts paper','ls_qq.png'),lsqq,h=3,w=8)
```


### Environmental Niches

```{r,fig.width=8}
make_fitted_env_niches <- function(simsdf,gcm,sppname){
  d <- simsdf %>% 
    filter(esm==gcm) %>%
    pivot_longer(contains('sim'),names_to="sim",values_to="est") %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m,esm) %>% 
    summarise(mean_est=mean(est,na.rm=T)) %>% 
    ungroup() %>% 
    left_join(roms,by=c("year", "longitude", "latitude", "lat", "lon"))
  niches <- purrr::map_df(c(0.05,0.5,0.75,0.95),function(thresh){
    make_spp_concave_hull(ens_preds=d,yr_vec=1985:2010,sppname=sppname,threshold=thresh,esm=gcm,lt=50,concavity = 3) %>% 
      mutate(threshold=thresh)
  })
  niches_plot <- ggplot(niches,aes(V1,V2,color=as.factor(threshold)))+
    geom_polygon(fill=NA,size=1.25)+
    scale_x_continuous(limits=c(0,14),breaks=seq(0,14,by=2))+
    scale_y_continuous(limits=c(0,280),breaks=seq(0,250,by=50))+
    labs(y="Bottom Oxygen (mmol/m3)",x="Bottom Temperature",color="Quantile of\nCPUE values",
       title=paste(tools::toTitleCase(sppname),toupper(gcm),"\n1985-2010"))+
    theme(legend.position=c(0.25,0.7),
          panel.background = element_rect(color='black'))
  niches_plot
}
```


```{r}
dover_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='dover sole',
                           simsdf=dover_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

sable_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='sablefish',
                           simsdf=sable_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

ss_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='shortspine',
                        simsdf=ss_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

ls_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='longspine',
                        simsdf=ls_ens_separate) %>% plot_grid(plotlist=.,nrow=1)
ggsave(here('model output','dts paper','dover_envir_niche.png'),dover_niches,h=6,w=8)
ggsave(here('model output','dts paper','sable_envir_niche.png'),sable_niches,h=6,w=8)
ggsave(here('model output','dts paper','ss_envir_niche.png'),ss_niches,h=6,w=8)
ggsave(here('model output','dts paper','ls_envir_niche.png'),ls_niches,h=6,w=8)

```

# Manuscript Figures

## Figure 1

Index of abundance

```{r,eval=F}
tic("Dover indices:")
dover_ind_ipsl <- make_index_sims(dover_models,gcm="ipsl")
dover_ind_gfdl <- make_index_sims(dover_models,gcm="gfdl")
dover_ind_hadl <- make_index_sims(dover_models,gcm="hadl")
dover_ind_all <- dover_ind_ipsl %>% 
  bind_rows(dover_ind_gfdl) %>% 
  bind_rows(dover_ind_hadl)
toc()

tic("Sablefish indices:")
sable_ind_ipsl <- make_index_sims(sable_models,gcm="ipsl")
sable_ind_gfdl <- make_index_sims(sable_models,gcm="gfdl")
sable_ind_hadl <- make_index_sims(sable_models,gcm="hadl")
sable_ind_all <- sable_ind_ipsl %>% 
  bind_rows(sable_ind_gfdl) %>% 
  bind_rows(sable_ind_hadl)
toc()

tic("Shortspine indices:")
ss_ind_ipsl <- make_index_sims(ss_models,gcm="ipsl")
ss_ind_gfdl <- make_index_sims(ss_models,gcm="gfdl")
ss_ind_hadl <- make_index_sims(ss_models,gcm="hadl")
ss_ind_all <- ss_ind_ipsl %>% 
  bind_rows(ss_ind_gfdl) %>% 
  bind_rows(ss_ind_hadl)
toc()

tic("Longspine indices:")
ls_ind_ipsl <- make_index_sims(ls_models,gcm="ipsl")
ls_ind_gfdl <- make_index_sims(ls_models,gcm="gfdl")
ls_ind_hadl <- make_index_sims(ls_models,gcm="hadl")
ls_ind_all <- ls_ind_ipsl %>% 
  bind_rows(ls_ind_gfdl) %>% 
  bind_rows(ls_ind_hadl)
toc()
```

```{r,eval=F}
write_rds(sable_ind_all,here('model output','dts paper','sable_abun_indices.rds'))
write_rds(dover_ind_all,here('model output','dts paper','dover_abun_indices.rds'))
write_rds(ss_ind_all,here('model output','dts paper','ss_abun_indices.rds'))
write_rds(ls_ind_all,here('model output','dts paper','ls_abun_indices.rds'))
```
```{r}
sable_ind_all<-read_rds(here('model output','dts paper','sable_abun_indices.rds'))
dover_ind_all<-read_rds(here('model output','dts paper','dover_abun_indices.rds'))
ss_ind_all<-read_rds(here('model output','dts paper','ss_abun_indices.rds'))
ls_ind_all<-read_rds(here('model output','dts paper','ls_abun_indices.rds'))
```

```{r,fig.height=4,fig.width=3}
# 
fourspp_ind_all <- dover_ind_all %>% mutate(spp="Dover sole") %>% 
  bind_rows(sable_ind_all %>% mutate(spp="Sablefish")) %>% 
  bind_rows(ss_ind_all %>% mutate(spp="Shortspine thornyhead")) %>% 
  bind_rows(ls_ind_all %>% mutate(spp="Longspine thornyhead")) %>% 
  mutate(spp=factor(spp,levels=c("Dover sole","Sablefish","Shortspine thornyhead","Longspine thornyhead")))

fourspp_ind_plot <- fourspp_ind_all %>% 
  filter(year>2021) %>% 
  ggplot(aes(year,wtd.log_est_smooth,
             ymin=wtd.log_est_smooth-wtd.se_est_smooth,
             ymax=wtd.log_est_smooth+wtd.se_est_smooth,
             color=esm,fill=esm))+
  geom_ribbon(alpha=0.5,fill='grey80',linetype=0)+
  geom_line(size=1.5)+
  scale_x_continuous(expand=c(0,0))+
  facet_wrap(~spp,nrow=4,scales='free_y')+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  scale_fill_manual(values=c("#009175","#7E0018","#00C2F9"))+
  labs(x="Year",y="Coastwide Index of Abundance",color="ESM",fill="ESM")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        legend.position = 'bottom',
        axis.text.x = element_text(angle=30,vjust=1,hjust=1))

# fourspp_ind_fig <- ggdraw()+
#   draw_plot(fourspp_ind_plot)+
#   draw_image(here('data','icons','dover1.png'),hjust=.35,vjust=-.37,scale=0.1)+
#   draw_image(here('data','icons','sablefish.png'),hjust=-.15,vjust=-.37,scale=0.12)+
#   draw_image(here('data','icons','shortspine.png'),hjust=.35,vjust=.01,scale=0.1)+
#   draw_image(here('data','icons','longspinet.png'),hjust=-.15,vjust=.01,scale=0.1)
fourspp_ind_fig <- ggdraw()+
  draw_plot(fourspp_ind_plot)+
  draw_image(here('data','icons','dover1.png'),hjust=.17,vjust=-.43,scale=0.23)+
  draw_image(here('data','icons','sablefish.png'),hjust=.17,vjust=-.12,scale=0.25)+
  draw_image(here('data','icons','shortspine.png'),hjust=.17,vjust=.08,scale=0.23)+
  draw_image(here('data','icons','longspinet.png'),hjust=.17,vjust=.22,scale=0.23)
fourspp_ind_fig
```
Coastwide environmental change

```{r,fig.height=7,fig.width=3}
coast_t_o_hist <- roms %>% 
  dplyr::select(mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl,latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t=mean(mean_bt_30d_ipsl),oxy=mean(mean_oxy_bottom_30d_ipsl)) %>% 
  ungroup() 
coast_t_o_fut <- roms %>% 
  dplyr::select(mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl,latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(mean_bt_30d_ipsl),oxy_fut=mean(mean_oxy_bottom_30d_ipsl)) %>% 
  ungroup()
coast_t_o <- coast_t_o_hist %>% 
  left_join(coast_t_o_fut,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

pred_points <- coast_t_o %>% dplyr::select(longitude,latitude) %>% as.matrix()
nns <- nn2(pred_points,gr_xy,k=1)$nn.idx
t_o_grid <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o$diff_t[nns],diff_o=coast_t_o$diff_o[nns])

coast_t_plot <- t_o_grid %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot <- t_o_grid %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))
# 
# coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,nrow=1,rel_widths = c(1,-0.7,1))
coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,ncol=1,rel_heights = c(1,-0.1,1))
coast_t_o_plot
```

```{r,fig.height=7,fig.width=6}
fig1 <- plot_grid(coast_t_o_plot,fourspp_ind_fig,ncol=2,labels='auto',rel_widths = c(0.8,1))
fig1
ggsave(here('model output','dts paper','fig1.png'),fig1,w=6,h=7)
```

## Figure 2

Weighted distance from shore
```{r}
fourspp_reldist <- purrr::map(four_spp_list,calc_rel_dist_to_shore)
fourspp_reldist <- bind_rows(fourspp_reldist,.id='species')

#historical average
fourspp_reldist_hist <- fourspp_reldist %>% 
  filter(year %in% c(1985:2010)) %>% 
  group_by(species,lat,esm,sim) %>% 
  summarise(mean_dist_hist=mean(dist)) %>% 
  ungroup()

# end of century
fourspp_reldist_fut <- fourspp_reldist %>% 
  filter(year %in% c(2075:2100)) %>% 
  group_by(species,lat,esm,sim) %>% 
  summarise(mean_dist_fut=mean(dist)) %>% 
  ungroup()

# bind again
fourspp_reldist_change <- fourspp_reldist_hist %>% 
  left_join(fourspp_reldist_fut,by=c('species','lat','esm','sim')) %>%
  mutate(change=mean_dist_fut-mean_dist_hist) %>%
  # add some plotting helpers
    mutate(spp_plotting=case_when(
      species=='dover' ~ "Dover Sole",
      species=="ls" ~ "Longspine",
      species=="ss"~"Shortspine",
      species=="sable" ~"Sablefish"
    )) %>% 
    mutate(spp_plotting=factor(spp_plotting,levels=c("Dover Sole","Sablefish","Shortspine","Longspine"))) %>% 
  mutate(ESM=toupper(esm))
```

```{r}
footprint_dist_to_shore <- footprints %>% 
  st_join(roms_dist_to_coast %>% st_as_sf(coords=c('longitude','latitude'),crs="+proj=utm +zone=10 +datum=WGS84 +units=km")) %>%
  st_set_geometry(NULL) %>% 
  group_by(port_name) %>% 
  summarise(mean_km_to_coast=mean(km_to_coast))
```

```{r}
# latitudinal centroid of fishing footprints
fp_lat <- footprints %>% st_centroid() %>% st_transform(4326) %>% 
  st_coordinates() %>% as_tibble() %>% set_names(c("lon","lat")) %>% 
  mutate(yint=0)
```

Make the plot

```{r}
four_spp_dist_to_shore_change <- ggplot(data=fourspp_reldist_change,
             aes(x=lat,y=change,fill=spp_plotting,col=spp_plotting))+
  geom_point(color='gray80',alpha=0.2,size=0.7)+
  geom_hline(yintercept=0,linetype=2)+
  geom_smooth(data=fourspp_reldist_change,
             aes(x=lat,y=change,fill=spp_plotting,col=spp_plotting))+
  # geom_point(data=fp_lat,aes(x=lat,y=-20),color='black',size=2)+
  scale_y_continuous(limits=c(-20,20))+
  facet_wrap(~ESM,nrow=1)+
  scale_color_manual(values=pal4)+
  # scale_fill_manual(values=pal4)+
  # scale_y_reverse(limits=c(90,20))+
  coord_flip()+
  guides(fill='none')+
  # theme(legend.position = c(0.8,0.7))+
  labs(y="Change in Distance from Shore (km)",x="Latitude",col="Species",fill="Species")+
  theme(panel.background = element_rect(fill=NA,color='black'))

four_spp_dist_to_shore_change
```

```{r}
ggsave(here('model output','dts paper','four species distance from shore.png'),four_spp_dist_to_shore_change,w=8,h=6)
```

Depth change

```{r}
fourspp_depth <- purrr::map(four_spp_list,calc_depth_frac,start_year=2020,end_year=2100) %>% bind_rows(.id='species')

fourspp_depth_plot <- fourspp_depth %>% 
    mutate(spp_plotting=case_when(
      species=='dover' ~ "Dover Sole",
      species=="ls" ~ "Longspine",
      species=="ss"~"Shortspine",
      species=="sable" ~"Sablefish"
    )) %>% 
    mutate(spp_plotting=factor(spp_plotting,levels=c("Dover Sole","Sablefish","Shortspine","Longspine"))) %>% 
  mutate(ESM=toupper(esm)) %>% 
  group_by(species,year,esm) %>% 
  slice_sample(n=25) %>% 
  ungroup() %>% 
  ggplot(aes(x=year,y=frac,col=spp_plotting,fill=spp_plotting))+
  geom_point(alpha=0.2,size=0.7,col='gray80')+
  geom_smooth(se=F)+
  scale_color_manual(values=pal4)+
  scale_fill_manual(values=pal4)+
  facet_wrap(~ESM,nrow=1)+
  # scale_color_manual(values=c("#2271B2","#d55e00"))+
  labs(x="Year",y="Proportion < 700 fathoms",title="",fill="Species",col="Species")+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10),
        panel.background = element_rect(fill=NA,color='black'),
        legend.position="bottom")
fourspp_depth_plot
```

```{r}
ggsave(here('model output','dts paper','fig_depth_change_four_spp.png'),fourspp_depth_plot,w=6,h=4)
```


```{r,fig.width=7,fig.height=5}
leg <- get_legend(fourspp_depth_plot)
fig_dist_depth_change<-plot_grid(four_spp_dist_to_shore_change+theme(plot.margin=unit(c(0.5,0.5,0.1,0.5),'cm'))+guides(color='none',fill='none'),
                                 fourspp_depth_plot + guides(color='none',fill='none') + theme(plot.margin=unit(c(0,0.5,1.5,0.5),'cm')),
                                 nrow=2,labels='auto')
fig_dist_depth_change<-ggdraw()+
  draw_plot(fig_dist_depth_change)+
  draw_plot(leg,y=-0.45)

ggsave(here('model output','dts paper','fig_dist_depth_change.png'),fig_dist_depth_change,w=8,h=7.5)
```

## Figure 3

Fishing footprints

```{r}
bbox=st_bbox(projection_extent)
footprints_map <- ggplot()+
  geom_sf(data=footprints,aes(fill=port_name),alpha=0.5)+
  geom_sf(data=coast,col=NA,fill='gray80')+
  # geom_sf(data=isobaths,col='gray20')+
  geom_sf(data=port_coords,aes(color=port_name),size=3)+
  scale_fill_npg()+
  scale_color_npg()+
  guides(color='none')+
  # guides(color="none",fill='none')+
  coord_sf(datum=NA)+
  labs(fill="Port")+
  xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
  theme(
        legend.text=element_text(size=8),
        legend.background = element_rect(fill='white',color='black'),
        legend.position=c(0.7,0.65))
```

Environmental state space within fishing footprints

```{r}
roms_env_space <- roms %>% 
  dplyr::select(year,lat,lon,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>% 
  distinct() %>% 
  left_join(roms_ll,by=c('lon','lat')) %>% 
  drop_na() %>% 
  rename(t=mean_bt_30d_ipsl,oxy=mean_oxy_bottom_30d_ipsl) %>% 
  mutate(depth_bin=cut(depth_m,breaks=c(0,-100,-250,-500,-1000,-3000),
                       labels=c("1000-3000m","500-1000m","250-500m","100-250m","0-100m")),
         lat_bin=cut(lat,breaks=c(30,33,36,39,42,45,48),labels=c("30-33","33-36","36-39","39-42","42-45","45-48")))
roms_env_space_hist <- roms_env_space %>%
  # historical "mean" is 1985-2010
  filter(year%in%c(1985:2010)) %>%
  group_by(lat,lon,roms_cell,depth_m,depth_bin,lat_bin) %>% 
  summarise(t_hist=mean(t,na.rm=T),oxy_hist=mean(oxy,na.rm=T)) %>% 
  ungroup()

roms_env_space_fut <- roms_env_space %>%
  # historical "mean" is 1985-2010
  filter(year%in%c(2075:2100)) %>%
  group_by(lat,lon,roms_cell,depth_m,depth_bin,lat_bin) %>% 
  summarise(t_fut=mean(t,na.rm=T),oxy_fut=mean(oxy,na.rm=T)) %>% 
  ungroup()

roms_env_space_sf <- roms_env_space_hist %>% 
  left_join(roms_env_space_fut, c("lat", "lon", "roms_cell", "depth_m", "depth_bin", "lat_bin")) %>%
  st_as_sf(coords=c('lon','lat'),crs=4326) %>% 
  st_transform(st_crs(footprints)) %>% 
  st_join(footprints)

footprint_env_space <- roms_env_space_sf %>% 
  drop_na() %>% 
  group_by(port_name,port_group) %>% 
  summarise(mean_t_hist=mean(t_hist),mean_oxy_hist=mean(oxy_hist),
            mean_t_fut=mean(t_fut),mean_oxy_fut=mean(oxy_fut)) %>% 
  ungroup()
```

Make environmental affinities ellipses

```{r}
library(ggnewscale)
aff_polys<-affinities_ellipses(four_spp,yr_vec=1985:2010,concavity=5,threshold=0.25,lt=50)
# plotting order for colors
polys_and_footprints <- ggplot()+
  geom_polygon(data=aff_polys,aes(V1,V2,col=spp_plotting),fill=NA,size=1,linetype=3)+
  scale_color_manual(values=c(pal4),name="Top 75% of\nspecies' CPUE")+
  new_scale_color()+
  geom_segment(data=footprint_env_space,aes(x=mean_t_hist,y=mean_oxy_hist,xend=mean_t_fut,yend=mean_oxy_fut,
             col=port_name),size=1,linetype=1,arrow=ggplot2::arrow(type="open",length=unit(0.1,'inches')))+
  scale_color_npg(name="Port Group\nClimate")+
  labs(x="Bottom Temperature (deg C)",y="Bottom Oxygen (mmol/m3)")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        panel.border = element_rect(color='black',fill=NA),
        axis.text=element_text(size=12))
```

```{r}
# with fish icons
polys_and_footprints_fig <- ggdraw()+
  draw_plot(polys_and_footprints)+
  draw_image(here('data','icons','dover1.png'),hjust=0.03,vjust=-.4,scale=0.13)+
  draw_image(here('data','icons','sablefish.png'),hjust=.08,vjust=-.2,scale=0.17)+
  draw_image(here('data','icons','shortspine.png'),hjust=.14,vjust=-.03,scale=0.15)+
  draw_image(here('data','icons','longspinet.png'),hjust=.23,vjust=.08,scale=0.13)
polys_and_footprints_fig  
```


```{r}
footprint_db_temp_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_t_hist,xend=mean_t_fut,y=fct_rev(port_name)))+
  geom_dumbbell(color="#FCAE91",colour_x =NA,colour_xend = "#A50F15",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Temperature",y="")+
  scale_y_discrete(position='right')+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text.y=element_text(color=rev(pal_npg()(6))))
# footprint_db_temp_plot

footprint_db_oxy_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_oxy_hist,xend=mean_oxy_fut,y=fct_rev(port_name)))+
  geom_dumbbell(color="#a3c4dc",colour_x =NA,colour_xend = "#0e668b",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Oxygen",y="")+
  theme(axis.text.y = element_blank(),panel.border = element_rect(color='black',fill=NA))
# footprint_db_oxy_plot
footprint_env_change_map <- plot_grid(footprints_map,NULL,footprint_db_oxy_plot,footprint_db_temp_plot,ncol=4,rel_widths = c(0.6,-0.1,0.45,0.6),labels=c('a','','b','c'),hjust=c(-0.5,0,-0.5,0.4))
footprint_env_change_map
```

```{r,fig.width=8,fig.height=8}
# attach dumbbell plots
# footprint_db_temp_plot2 <- footprint_env_space %>% 
#   ggplot(aes(x=mean_t_hist,xend=mean_t_fut,y=fct_rev(port_name)))+
#   geom_dumbbell(color="#FCAE91",colour_x =NA,colour_xend = "#A50F15",
#                 size=1,size_x=3,size_xend = 3) +
#   labs(x="Temperature",y="")+
#   # coord_flip()+
#   theme(panel.border = element_rect(color='black',fill=NA),
#         axis.text.y=element_text(color=pal_npg()(7),size=10))
# 
# footprint_db_oxy_plot2 <- footprint_env_space %>% 
#   ggplot(aes(x=mean_oxy_hist,xend=mean_oxy_fut,y=fct_rev(port_name)))+
#   geom_dumbbell(color="#a3c4dc",colour_x =NA,colour_xend = "#0e668b",
#                 size=1,size_x=3,size_xend = 3) +
#   labs(x="Oxygen",y="")+
#   # coord_flip()+
#   theme(axis.text.y=element_text(color=pal_npg()(7),size=10),
#         panel.border = element_rect(color='black',fill=NA))

# fig3 <- plot_grid(footprint_db_temp_plot2,footprint_db_oxy_plot2,polys_and_footprints,labels='auto',nrow=3,
#                   hjust = 0,vjust=1,
#                   rel_heights = c(0.2,0.2,0.6))
```

```{r,fig.height=8,fig.width=8}
fig3 <- plot_grid(footprint_env_change_map,polys_and_footprints_fig,labels=c("",'d'),nrow=2,
                  hjust = 0,vjust=1,
                  rel_heights = c(0.5,0.5))
fig3
ggsave(here('model output','dts paper','fig_env_change_env_affs.png'),fig3,h=8,w=8)
```

## Figure 4

CPUE/Density
```{r}
allspp_reldens <- purrr::map2_df(list(dover_ens_separate,sable_ens_separate,ss_ens_separate,ls_ens_separate),
                                 c('dover','sable','shortspine','longspine'),
                                 function(x,y){
                                   calc_footprint_reldens_sims(x) %>% mutate(spp=y)
                                 }) %>%
  mutate(ESM=toupper(esm)) %>% 
  mutate(spp_plotting=case_when(
      spp=='dover' ~ "Dover Sole",
      spp=="longspine" ~ "Longspine",
      spp=="shortspine"~"Shortspine",
      spp=="sable" ~"Sablefish"
    )) %>% 
  mutate(spp_plotting=factor(spp_plotting,levels=c("Sablefish","Dover Sole","Shortspine","Longspine"))) %>% 
  # mutate(delta_perc=ifelse(delta_perc>200|delta_perc < -200,NA,delta_perc)) %>% 
  drop_na()
```

```{r}
dover_dens_fp<-calc_footprint_dens_sims(dover_ens_sims)
sable_dens_fp<-calc_footprint_dens_sims(sable_ens_sims)

dover_sable_dens_change <- dover_dens_fp %>% 
  left_join(sable_dens_fp,by=c("port_name","year")) %>% 
  mutate(ratio=mean_cpue.x/mean_cpue.y)
# dover_dens_fp <- dover_dens_fp %>% 
#   group_by(port_name) %>%
#   arrange(year) %>% 
#   mutate(l1=lag(mean_cpue,1),
#            l2=lag(mean_cpue,2),
#            l3=lag(mean_cpue,3),
#            l4=lag(mean_cpue,4),
#            l5=lag(mean_cpue,5),
#            lse1=lag(cpue5,1),
#            lse2=lag(cpue5,2),
#            lse3=lag(cpue5,3),
#            lse4=lag(cpue5,4),
#            lse5=lag(cpue5,5),
#            l95.1=lag(cpue95,1),
#            l95.2=lag(cpue95,2),
#            l95.3=lag(cpue95,3),
#            l95.4=lag(cpue95,4),
#            l95.5=lag(cpue95,5)) %>% 
#     mutate(mean_cpue_smooth=(l1+l2+l3+l4+l5)/5,
#            cpue5_smooth=(lse1+lse2+lse3+lse4+lse5)/5,
#            cpue95_smooth=(l95.1+l95.2+l95.3+l95.4+l95.5)/5) 
# dover_dens_fp %>% 
#   filter(port_name%in%c('Astoria',"Fort Bragg")) %>% 
#   ggplot(aes(year,mean_cpue_smooth,ymin=cpue5_smooth,ymax=cpue95_smooth))+
#   geom_ribbon(fill='gray80')+
#   geom_line()+
#   facet_wrap(~port_name)
# 
# sable_dens_fp <- sable_dens_fp %>% 
#   group_by(port_name) %>%
#   arrange(year) %>% 
#   mutate(l1=lag(mean_cpue,1),
#            l2=lag(mean_cpue,2),
#            l3=lag(mean_cpue,3),
#            l4=lag(mean_cpue,4),
#            l5=lag(mean_cpue,5),
#            lse1=lag(cpue5,1),
#            lse2=lag(cpue5,2),
#            lse3=lag(cpue5,3),
#            lse4=lag(cpue5,4),
#            lse5=lag(cpue5,5),
#            l95.1=lag(cpue95,1),
#            l95.2=lag(cpue95,2),
#            l95.3=lag(cpue95,3),
#            l95.4=lag(cpue95,4),
#            l95.5=lag(cpue95,5)) %>% 
#     mutate(mean_cpue_smooth=(l1+l2+l3+l4+l5)/5,
#            cpue5_smooth=(lse1+lse2+lse3+lse4+lse5)/5,
#            cpue95_smooth=(l95.1+l95.2+l95.3+l95.4+l95.5)/5) 
# sable_dens_fp %>% 
#   filter(port_name%in%c('Astoria',"Fort Bragg")) %>% 
#   ggplot(aes(year,mean_cpue_smooth,ymin=cpue5_smooth,ymax=cpue95_smooth))+
#   geom_ribbon(fill='gray80')+
#   geom_line()+
#   facet_wrap(~port_name)
```


```{r}
dover_sable_reldens <- allspp_reldens %>% 
  filter(spp %in% c('dover','sable'),
         port_name%in%c('Astoria','Fort Bragg')) %>% 
  ggplot(aes(delta_perc,fill=spp_plotting))+
  geom_density()+
  geom_vline(xintercept=0,linetype=2)+
  scale_fill_manual(values=pal4)+
  facet_grid(ESM~port_name)+
  labs(x=expression(paste(Delta,"CPUE")),y="Kernel Density",fill="")+
  theme(legend.position = 'bottom',
        strip.text = element_text(size=10),
        panel.background = element_rect(color='black'))

dover_sable_reldens
```

Trying overlap metrics

```{r}
dover_sable_overlap_change <- purrr::map_df(c('gfdl','hadl','ipsl'),
                                            lic_D_fps,
                                            sims_df1=dover_ens_separate,
                                            sims_df2=sable_ens_separate,fp=footprints) %>% 
  filter(year>2074)

dover_sable_overlap_fp <- dover_sable_overlap_change %>% 
  mutate(ESM=toupper(esm)) %>% 
  group_by(port_name,ESM) %>% 
  summarise(mean_change=mean(deltaD),upper=mean(deltaD)+sd(deltaD),lower=mean(deltaD)-sd(deltaD)) %>% 
  filter(port_name%in%c("Astoria","Fort Bragg")) %>% 
  ggplot(aes(port_name,mean_change,ymin=lower,ymax=upper))+
  geom_pointrange()+
  geom_hline(yintercept=0,linetype=2)+
  facet_wrap(~ESM,nrow=3)+
  labs(x="Port Group",y=expression(paste(Delta,"D")))
  # xlim(c(-0.03,0.03))+
  # scale_color_manual(values=viridis_pal(option="D",begin=0.2,end=0.8)(3))
  # facet_wrap(~port_name)
dover_sable_overlap_fp
```

```{r}
# dover_sable_bwo <- bwo_sims(dover_ens_separate,sable_ens_separate)
# dover_sable_bwo_hist <- dover_sable_bwo %>% 
#   filter(year %in% c(1985:2010)) %>% 
#   group_by(port_name,esm,sim) %>% 
#   summarise(bwo_hist=mean(bwo)) %>% 
#   ungroup()
# dover_sable_bwo_fut <- dover_sable_bwo %>% 
#   filter(year %in% c(2075:2100)) %>% 
#   group_by(port_name,esm,sim) %>% 
#   summarise(bwo_fut=mean(bwo)) %>% 
#   ungroup()
# dover_sable_bwo_diff <- dover_sable_bwo_hist %>% 
#   left_join(dover_sable_bwo_fut) %>% 
#   mutate(bwod=bwo_fut-bwo_hist) %>% 
#   group_by(port_name,esm) %>% 
#   summarise(meandiff=mean(bwod),
#             sddiff=sd(bwod)) %>% 
#   mutate(lower=meandiff-sddiff,upper=meandiff+sddiff) %>% 
#   ungroup()
#   
# 
# dover_sable_bwo_plot <- dover_sable_bwo_diff %>% 
#   mutate(ESM=toupper(esm)) %>% 
#   filter(port_name%in%c("Astoria","Fort Bragg")) %>% 
#   ggplot(aes(port_name,meandiff,ymin=lower,ymax=upper))+
#   geom_pointrange()+
#   geom_hline(yintercept=0,linetype=2)+
#   facet_wrap(~ESM,nrow=3)+
#   labs(x="Port Group",y=expression(paste(Delta,"BWO")))
# dover_sable_bwo_plot
```

```{r}
dover_sable_bhat <- bhat_sims(dover_ens_separate,sable_ens_separate)
dover_sable_bhat_hist <- dover_sable_bhat %>%
  filter(year %in% c(1985:2010)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(bhat_hist=mean(bhat)) %>%
  ungroup()
dover_sable_bhat_fut <- dover_sable_bhat %>%
  filter(year %in% c(2075:2100)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(bhat_fut=mean(bhat)) %>%
  ungroup()
dover_sable_bhat_diff <- dover_sable_bhat_hist %>%
  left_join(dover_sable_bhat_fut) %>%
  mutate(bhatd=bhat_fut-bhat_hist) %>%
  group_by(port_name,esm) %>%
  summarise(meandiff=mean(bhatd),
            sddiff=sd(bhatd)) %>%
  mutate(lower=meandiff-sddiff,upper=meandiff+sddiff) %>%
  ungroup()

dover_sable_bhat_plot <- dover_sable_bhat_diff %>%
  mutate(ESM=toupper(esm)) %>%
  filter(port_name%in%c("Astoria","Fort Bragg")) %>%
  ggplot(aes(port_name,meandiff,ymin=lower,ymax=upper))+
  geom_pointrange()+
  geom_hline(yintercept=0,linetype=2)+
  facet_wrap(~ESM,nrow=3)+
  labs(x="Port Group",y=expression(paste(Delta,"Overlap")))+
  theme(panel.background = element_rect(color='black'),
        strip.text = element_text(size=10))
dover_sable_bhat_plot
```
```{r}
dover_sable_aa <- aa_sims(dover_ens_separate,sable_ens_separate)
dover_sable_aa_hist <- dover_sable_aa %>%
  filter(year %in% c(1985:2010)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(aa_hist=mean(aa)) %>%
  ungroup()
dover_sable_aa_fut <- dover_sable_aa %>%
  filter(year %in% c(2075:2100)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(aa_fut=mean(aa)) %>%
  ungroup()
dover_sable_aa_diff <- dover_sable_aa_hist %>%
  left_join(dover_sable_aa_fut) %>%
  mutate(aad=aa_fut-aa_hist) %>%
  group_by(port_name,esm) %>%
  summarise(meandiff=mean(aad),
            sddiff=sd(aad)) %>%
  mutate(lower=meandiff-sddiff,upper=meandiff+sddiff) %>%
  ungroup()

dover_sable_aa_plot <- dover_sable_aa_diff %>%
  mutate(ESM=toupper(esm)) %>%
  filter(port_name%in%c("Astoria","Fort Bragg")) %>%
  ggplot(aes(port_name,meandiff,ymin=lower,ymax=upper))+
  geom_pointrange()+
  geom_hline(yintercept=0,linetype=2)+
  facet_wrap(~ESM,nrow=3)+
  labs(x="Port Group",y=expression(paste(Delta,"Overlap")))+
  theme(panel.background = element_rect(color='black'),
        strip.text = element_text(size=10))
dover_sable_aa_plot
```

```{r}
dover_sable_cpue_overlap <- plot_grid(dover_sable_reldens,dover_sable_bhat_plot,ncol=2,rel_widths = c(1,0.7),labels='auto')
dover_sable_cpue_overlap
ggsave(here('model output','dts paper','fig_cpue_bhat_fp.png'),dover_sable_cpue_overlap,h=6,w=8)
```



# Supplementary Figures

## Cumulative Depth Distribution

```{r}
cume_depth_all <- purrr::map(list(dover_ens_all,sable_ens_all,ss_ens_all,ls_ens_all),plot_depth_distribution_sims) %>% plot_grid(plotlist=.,labels='auto',ncol=2)

cume_depth_plt <- ggdraw()+
  draw_plot(cume_depth_all)+
  draw_image(here('data','icons','dover1.png'),hjust=.27,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','sablefish.png'),hjust=-.26,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','shortspine.png'),hjust=.24,vjust=.3,scale=0.15)+
  draw_image(here('data','icons','longspinet.png'),hjust=-.26,vjust=.3,scale=0.15)
# cume_depth_plt

ggsave(here('model output','dts paper','four_spp_cume_depth_sims.png'),cume_depth_plt,w=8,h=6)
```

## Other ESMs

```{r}
coast_t_o_hist_hadl <- roms %>% 
  dplyr::select(mean_bt_30d_hadl,mean_oxy_bottom_30d_hadl,latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t=mean(mean_bt_30d_hadl),oxy=mean(mean_oxy_bottom_30d_hadl)) %>% 
  ungroup() 
coast_t_o_fut_hadl <- roms %>% 
  dplyr::select(mean_bt_30d_hadl,mean_oxy_bottom_30d_hadl,latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(mean_bt_30d_hadl),oxy_fut=mean(mean_oxy_bottom_30d_hadl)) %>% 
  ungroup()
coast_t_o_hadl <- coast_t_o_hist_hadl %>% 
  left_join(coast_t_o_fut_hadl,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

t_o_grid_hadl <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o_hadl$diff_t[nns],diff_o=coast_t_o_hadl$diff_o[nns])

coast_t_plot_hadl <- t_o_grid_hadl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot_hadl <- t_o_grid_hadl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))
# 
# coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,nrow=1,rel_widths = c(1,-0.7,1))
coast_t_o_plot_hadl <- plot_grid(coast_t_plot_hadl,NULL,coast_o_plot_hadl,ncol=1,rel_heights = c(1,-0.1,1))
coast_t_o_plot_hadl
```
```{r}
coast_t_o_hist_gfdl <- roms %>% 
  dplyr::select(mean_bt_30d_gfdl,mean_oxy_bottom_30d_gfdl,latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t=mean(mean_bt_30d_gfdl),oxy=mean(mean_oxy_bottom_30d_gfdl)) %>% 
  ungroup() 
coast_t_o_fut_gfdl <- roms %>% 
  dplyr::select(mean_bt_30d_gfdl,mean_oxy_bottom_30d_gfdl,latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(mean_bt_30d_gfdl),oxy_fut=mean(mean_oxy_bottom_30d_gfdl)) %>% 
  ungroup()
coast_t_o_gfdl <- coast_t_o_hist_gfdl %>% 
  left_join(coast_t_o_fut_gfdl,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

t_o_grid_gfdl <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o_gfdl$diff_t[nns],diff_o=coast_t_o_gfdl$diff_o[nns])

coast_t_plot_gfdl <- t_o_grid_gfdl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot_gfdl <- t_o_grid_gfdl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))
# 
# coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,nrow=1,rel_widths = c(1,-0.7,1))
coast_t_o_plot_gfdl <- plot_grid(coast_t_plot_gfdl,NULL,coast_o_plot_gfdl,ncol=1,rel_heights = c(1,-0.1,1))
coast_t_o_plot_gfdl
```
```{r}
fig_hadl_gfdl_ipsl_change <- plot_grid(coast_t_o_plot,coast_t_o_plot_gfdl,coast_t_o_plot_hadl,ncol=3,labels=c("IPSL","GFDL","HADL"))
fig_hadl_gfdl_ipsl_change
ggsave(here::here('model output','dts paper','ESMs_env_change.png'),fig_hadl_gfdl_ipsl_change,h=7,w=10)
```



# Deprecated/Old

## Old Fig 1

```{r}
landings_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T)) %>% 
  ggplot(aes(Year,tot_dollars/1e6,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Landings (Million $)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.13,0.75),
        legend.text = element_text(size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
landings_plot
ppp_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T),
            tot_lbs=sum(Pounds,na.rm=T)) %>% 
  mutate(ppp=tot_dollars/tot_lbs) %>% 
  ggplot(aes(Year,ppp,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Price Per Pound ($)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.15,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
ppp_plot

lbs_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T),
            tot_lbs=sum(Pounds,na.rm=T)) %>% 
  mutate(ppp=tot_dollars/tot_lbs) %>% 
  ggplot(aes(Year,tot_lbs/1000,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Thousand Pounds",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.15,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
lbs_plot
```

Overlap map (count number of species in each cell). This figure shows the number of species out of four in each grid cell that are at or above their median CPUE (across all cells) for that year.

```{r,fig.width=6,fig.height=8}
multimapdiff <- map_multispp_diff(four_spp,qlower=0.75,qupper=1)
# multimapdiff
```

Finish Figure 1

```{r}
# row2 <- plot_grid(footprints_map,multimapdiff,labels=c('b','c'),nrow=1,rel_widths = c(0.8,1))
# multimapcomp <- plot_grid(landings_plot,row2,nrow=2,rel_heights = c(0.3,0.7),labels='auto')
# multimapcomp
# 
# ggsave(here('model output','dts paper','fig1.png'),multimapcomp,w=6,h=8)
```
## Old Figure 4
Calculate GIC for each species combination, year, simulation, and ESM

```{r,eval=F}
tic("Ran GIC for sims")
dover_sable_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=dover_ens_separate,sims_df2=sable_ens_separate))

dover_ss_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=dover_ens_separate,sims_df2=ss_ens_separate))

dover_ls_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=dover_ens_separate,sims_df2=ls_ens_separate))

sable_ss_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=sable_ens_separate,sims_df2=ss_ens_separate))

sable_ls_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=sable_ens_separate,sims_df2=ls_ens_separate))

ss_ls_gic<-crossing(gcm=c('gfdl','ipsl','hadl'),simnum=1:100) %>%
  mutate(gic=purrr::pmap(list(gcm,simnum),gic_sims,sims_df1=ss_ens_separate,sims_df2=ls_ens_separate))
toc()
# ~ 6 minutes total
```
Calculate LIC and Schoener's D.

```{r,eval=F}
tic("Ran LIC and D for sims")
dover_sable_lic <- lic_D_sims(dover_ens_separate,sable_ens_separate)
dover_ss_lic <- lic_D_sims(dover_ens_separate,ss_ens_separate)
dover_ls_lic <- lic_D_sims(dover_ens_separate,ls_ens_separate)
sable_ss_lic <- lic_D_sims(sable_ens_separate,ss_ens_separate)
sable_ls_lic <- lic_D_sims(sable_ens_separate,ls_ens_separate)
ss_ls_lic <- lic_D_sims(ss_ens_separate,ls_ens_separate)
toc()
# ~5 minutes total
```
Join and plot

```{r,eval=F}
dover_sable_overlap <- dover_sable_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(dover_sable_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
dover_ss_overlap <- dover_ss_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(dover_ss_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
dover_ls_overlap <- dover_ls_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(dover_ls_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
sable_ss_overlap <- sable_ss_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(sable_ss_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
sable_ls_overlap <- sable_ls_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(sable_ls_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
ss_ls_overlap <- ss_ls_gic %>% 
  unnest(cols=c(gic)) %>% 
  mutate(year=rep(1980:2100,300)) %>% 
  left_join(ss_ls_lic %>% mutate(simnum=str_remove(sim,'sim') %>% as.numeric()),
            by=c('gcm'='esm','simnum','year'))
```

```{r,eval=F}
# save overlap metrics
overlaps_all <- list(dover_sable_overlap,dover_ss_overlap,dover_ls_overlap,sable_ss_overlap,sable_ls_overlap,ss_ls_overlap) %>% set_names(c('dover_sable','dover_ss','dover_ls','sable_ss','sable_ls','ss_ls'))
write_rds(overlaps_all,here('model output','dts paper','overlap_metrics_all.rds'))
```

```{r}
# Load
overlaps_all <- read_rds(here('model output','dts paper','overlap_metrics_all.rds'))
```


```{r}
# make a good color palette
# 3 sets of 3 colors for the 3 ESMs and 3 metrics
overlaps_cols <- c("#009175","#7E0018","#00C2F9")
# overlaps_cols <- c("#005745","#009175","#00CBA7",
#                    "#7E0018","#CD022D","#FF6E3A",
#                    "#00306F","#005FCC","#00C2F9")
overlap_plot_foo <- function(overlap_df,show_legend=FALSE,show_axes=FALSE){
  p <- overlap_df %>% 
    filter(year>2019) %>% 
    pivot_longer(cols=c('gic','lic','D'),names_to='metric',values_to='value') %>% 
    unite(esm_metric,gcm,metric,remove=F) %>% 
    unite(sim_esm_metric,simnum,esm_metric,remove=F) %>% 
    mutate(esm_metric=toupper(esm_metric)) %>% 
    ggplot(aes(year,value,color=toupper(gcm),linetype=toupper(metric)))+
    # geom_point(alpha=0.2,size=0.7)+
    geom_line(aes(group=sim_esm_metric),color='gray80')+
    geom_smooth(se=F)+
    scale_color_manual(values=overlaps_cols)+
    scale_linetype_manual(values=c(1,3,4))+
    ylim(0,1)+
    labs(x="Year",y="Overlap",color="ESM",linetype="Metric")+
    theme(panel.background = element_rect(color="black",fill=NA),
          legend.position = 'bottom')
  out=p
  if(!show_legend) out=out+guides(color='none',linetype="none")
  if(!show_axes) out= out+theme(axis.title.y = element_blank())
  out
}
```

```{r,fig.width=8,fig.height=8}
dover_sable_overlap_plot <- overlap_plot_foo(overlaps_all$dover_sable,show_legend = T,show_axes=T)
dover_ss_overlap_plot <- overlap_plot_foo(overlaps_all$dover_ss,show_axes = T)
dover_ls_overlap_plot <- overlap_plot_foo(overlaps_all$dover_ls)
sable_ss_overlap_plot <- overlap_plot_foo(overlaps_all$sable_ss)
sable_ls_overlap_plot <- overlap_plot_foo(overlaps_all$sable_ls)
ss_ls_overlap_plot <- overlap_plot_foo(overlaps_all$ss_ls)
overlaps_legend <- get_legend(dover_sable_overlap_plot)

r1 <- plot_grid(dover_sable_overlap_plot+guides(color='none',linetype='none'),sable_ss_overlap_plot,sable_ls_overlap_plot,dover_ss_overlap_plot,dover_ls_overlap_plot,ss_ls_overlap_plot,nrow=2,labels='auto',vjust=1)
r2=plot_grid(NULL,NULL,overlaps_legend,NULL,NULL,nrow=1)

overlaps_all_fig4 <- plot_grid(r1,r2,nrow=2,rel_heights = c(1,0.2))

# add fish silhouettes
fig4<-ggdraw()+
  draw_plot(overlaps_all_fig4)+
  draw_image(here('data','icons','sablefish.png'),hjust=.36,vjust=-.17,scale=0.1)+
  draw_image(here('data','icons','dover1.png'),hjust=.25,vjust=-.17,scale=0.1)+
  draw_image(here('data','icons','sablefish.png'),hjust=0.05,vjust=-.17,scale=0.1)+
  draw_image(here('data','icons','shortspine.png'),hjust=-0.08,vjust=-.17,scale=0.1)+
  draw_image(here('data','icons','sablefish.png'),hjust=-.27,vjust=-.17,scale=0.1)+
  draw_image(here('data','icons','longspinet.png'),hjust=-.41,vjust=-.17,scale=0.1)+
  #row2
  draw_image(here('data','icons','dover1.png'),hjust=.36,vjust=.23,scale=0.1)+
  draw_image(here('data','icons','shortspine.png'),hjust=.25,vjust=.23,scale=0.1)+
  draw_image(here('data','icons','dover1.png'),hjust=0.06,vjust=.23,scale=0.1)+
  draw_image(here('data','icons','longspinet.png'),hjust=-0.08,vjust=.23,scale=0.1)+
  draw_image(here('data','icons','shortspine.png'),hjust=-.27,vjust=.23,scale=0.1)+
  draw_image(here('data','icons','longspinet.png'),hjust=-.41,vjust=.23,scale=0.1)
fig4

ggsave(here('model output','dts paper','fig_overlaps_all.png'),fig4,h=8,w=8)
```

## Figure 5

Timeseries with color shading (Hovmoller type plot)

```{r,eval=F,fig.height=8,fig.width=8}
dover_sable_lic_D <- LIC_D_prop_change(dover_ens_separate,sable_ens_separate)
dover_ss_lic_D <- LIC_D_prop_change(dover_ens_separate,ss_ens_separate)
dover_ls_lic_D <- LIC_D_prop_change(dover_ens_separate,ls_ens_separate)
sable_ss_lic_D <- LIC_D_prop_change(sable_ens_separate,ss_ens_separate)
sable_ls_lic_D <- LIC_D_prop_change(sable_ens_separate,ls_ens_separate)
ss_ls_lic_D <- LIC_D_prop_change(ss_ens_separate,ls_ens_separate)

# together
LIC_D_fps_all <- dover_sable_lic_D %>% mutate(spp="Sablefish/Dover Sole") %>% 
  bind_rows(dover_ss_lic_D %>% mutate(spp="Dover Sole/Shortspine")) %>%  
  bind_rows(dover_ls_lic_D %>% mutate(spp="Dover Sole/Longspine")) %>%  
  bind_rows(sable_ss_lic_D %>% mutate(spp="Sablefish/Shortspine")) %>%  
  bind_rows(sable_ls_lic_D %>% mutate(spp="Sablefish/Longspine")) %>%  
  bind_rows(ss_ls_lic_D %>% mutate(spp="Shortspine/Longspine")) %>% 
  mutate(spp=factor(spp,levels=c("Sablefish/Dover Sole","Sablefish/Shortspine","Sablefish/Longspine",
                                 "Dover Sole/Shortspine","Dover Sole/Longspine","Shortspine/Longspine")))

D_fps_plot <- LIC_D_fps_all %>% 
  mutate(ESM=toupper(esm)) %>% 
  ggplot(aes(year,fct_rev(spp),fill=D_prop/100,col=D_prop/100))+
  geom_tile()+
  # geom_point(size=0.2)+
  # geom_smooth(se=F)+
  facet_grid(port_name~ESM)+
  scale_x_continuous(expand=c(0,0))+
  # scale_y_continuous(limits=c(0,1))+
  scale_fill_gradient2(midpoint=0.5)+
  scale_color_gradient2(midpoint=0.5)+
  # geom_hline(yintercept=0.5,linetype=2)+
  labs(x="Year",y="Species Pair",fill="Proportion of Simulations\nwith Increased Overlap",
       color="Proportion of Simulations\nwith Increased Overlap")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        legend.position = 'bottom',
        axis.text.x = element_text(angle=45,vjust=0.8,hjust=0.8),
        legend.key.width = unit(0.75,'inches'),
        panel.spacing = unit(0.2,'inches'),
        strip.text = element_text(size=8),
        panel.border = element_rect(color='black',fill=NA,size=1.5))

D_fps_plot
# ggsave(here('model output','dts paper','fig_overlaps_footprints.png'),D_fps_plot,w=8,h=8)
```

Hurricane point range plot showing 2075-2100 mean change

```{r,fig.height=6,fig.width=8}
dover_sable_lic_D <- LIC_D_mean_change(dover_ens_separate,sable_ens_separate)
dover_ss_lic_D <- LIC_D_mean_change(dover_ens_separate,ss_ens_separate)
dover_ls_lic_D <- LIC_D_mean_change(dover_ens_separate,ls_ens_separate)
sable_ss_lic_D <- LIC_D_mean_change(sable_ens_separate,ss_ens_separate)
sable_ls_lic_D <- LIC_D_mean_change(sable_ens_separate,ls_ens_separate)
ss_ls_lic_D <- LIC_D_mean_change(ss_ens_separate,ls_ens_separate)

# together
LIC_D_fps_all <- dover_sable_lic_D %>% mutate(spp="Sablefish/Dover Sole") %>% 
  bind_rows(dover_ss_lic_D %>% mutate(spp="Dover Sole/Shortspine")) %>%  
  bind_rows(dover_ls_lic_D %>% mutate(spp="Dover Sole/Longspine")) %>%  
  bind_rows(sable_ss_lic_D %>% mutate(spp="Sablefish/Shortspine")) %>%  
  bind_rows(sable_ls_lic_D %>% mutate(spp="Sablefish/Longspine")) %>%  
  bind_rows(ss_ls_lic_D %>% mutate(spp="Shortspine/Longspine")) %>% 
  mutate(spp=factor(spp,levels=c("Sablefish/Dover Sole","Sablefish/Shortspine","Sablefish/Longspine",
                                 "Dover Sole/Shortspine","Dover Sole/Longspine","Shortspine/Longspine")))

# plot
D_fps_plot <- LIC_D_fps_all %>% 
  mutate(ESM=toupper(esm)) %>% 
  mutate(upper=D_mean+D_sd,lower=D_mean-D_sd) %>% 
  ggplot(aes(x=fct_rev(spp),y=D_mean,ymax=upper,ymin=lower,color=ESM))+
  geom_pointrange(position = position_dodge(width=0.3))+
  geom_hline(yintercept=0,linetype=2)+
  coord_flip()+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  facet_wrap(~port_name)+
  labs(x="Species Pair",y="Mean Change in Schoener's D",color="CCROMS Model")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        # legend.position = 'right',
        axis.text.x = element_text(angle=45,vjust=0.8,hjust=0.8),
        # legend.key.width = unit(0.75,'inches'),
        panel.spacing = unit(0.2,'inches'),
        strip.text = element_text(size=8),
        panel.border = element_rect(color='black',fill=NA,size=1.5))
D_fps_plot
ggsave(here('model output','dts paper','fig_overlaps_footprints.png'),D_fps_plot,w=8,h=6)
```

```{r,fig.height=6,fig.width=8}
# LIC plot- does it look any different?
LIC_fps_plot <- LIC_D_fps_all %>% 
  mutate(ESM=toupper(esm)) %>% 
  mutate(upper=L_mean+L_sd,lower=L_mean-L_sd) %>% 
  ggplot(aes(x=fct_rev(spp),y=L_mean,ymax=upper,ymin=lower,color=ESM))+
  geom_pointrange(position = position_dodge(width=0.3))+
  geom_hline(yintercept=0,linetype=2)+
  coord_flip()+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  facet_wrap(~port_name)+
  labs(x="Species Pair",y="Mean Change in LIC",color="CCROMS Model")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        # legend.position = 'right',
        axis.text.x = element_text(angle=45,vjust=0.8,hjust=0.8),
        # legend.key.width = unit(0.75,'inches'),
        panel.spacing = unit(0.2,'inches'),
        strip.text = element_text(size=8),
        panel.border = element_rect(color='black',fill=NA,size=1.5))
LIC_fps_plot
```



## Figure 6

Try a new way with smoothed histograms

```{r,fig.height=8,fig.width=8}
allspp_reldens <- purrr::map2_df(list(dover_ens_separate,sable_ens_separate,ss_ens_separate,ls_ens_separate),
                                 c('dover','sable','shortspine','longspine'),
                                 function(x,y){
                                   calc_footprint_reldens_sims(x) %>% mutate(spp=y)
                                 }) %>%
  mutate(ESM=toupper(esm)) %>% 
  mutate(spp_plotting=case_when(
      spp=='dover' ~ "Dover Sole",
      spp=="longspine" ~ "Longspine",
      spp=="shortspine"~"Shortspine",
      spp=="sable" ~"Sablefish"
    )) %>% 
  mutate(spp_plotting=factor(spp_plotting,levels=c("Sablefish","Dover Sole","Shortspine","Longspine"))) %>% 
  # mutate(delta_perc=ifelse(delta_perc>200|delta_perc < -200,NA,delta_perc)) %>% 
  drop_na()

reldens_fig <- allspp_reldens %>% 
  dplyr::select(sim,ESM,spp_plotting,delta_perc,port_name) %>% 
  mutate(spp_plotting=paste0('~',spp_plotting,'~')) %>% 
  unite(fct,spp_plotting,port_name,sep="\n",remove=F) %>% 
  mutate(fct=factor(fct,levels=unique(fct))) %>% 
  ggplot(aes(delta_perc,fill=ESM))+
  geom_density(alpha=0.5)+
  geom_vline(xintercept=0,linetype=2)+
  facet_wrap(~fct,scales='free',ncol=7)+
  # xlim(-200,200)+
  scale_color_manual(values=viridis_pal(option="D",begin=0.2,end=0.8)(3))+
  scale_fill_manual(values=viridis_pal(option="D",begin=0.2,end=0.8)(3))+
  labs(x="Percent Change in CPUE",y="",fill="CCROMS Model")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        axis.text.y=element_blank(),
        axis.text.x=element_text(angle=45,vjust=0.8,hjust=0.8),
        axis.ticks.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank())


  # nest(dat=c(sim,ESM,port_name,delta_perc)) %>% 
  # mutate(p=purrr::map(dat,function(d){
  #     d %>%
  #     ggplot(aes(delta_perc,fill=ESM))+
  #     geom_density(alpha=0.5)+
  #     geom_vline(xintercept=0,linetype=2)+
  #     facet_wrap(~port_name,scales='free_y',nrow=1)+
  #     # xlim(-200,200)+
  #     scale_color_npg()+
  #     scale_fill_npg()+
  #     labs(x="Percent Change in CPUE",y="",fill="CCROMS Model")+
  #     theme(panel.background = element_rect(fill=NA,color='black'),
  #           axis.text.y=element_blank(),
  #           panel.grid.major = element_blank(),
  #           panel.grid.minor=element_blank())
  # }))

# plot_grid(plotlist = reldens_fig$p,nrow=4)

reldens_fig
ggsave(here('model output','dts paper','fig_cpue_change_footprints.png'),reldens_fig,w=8,h=8)
```

```{r,fig.height=6,fig.width=3.5}
sable_reldens_fig <- allspp_reldens %>% 
  filter(spp_plotting=="Sablefish",ESM=="IPSL") %>% 
  dplyr::select(sim,ESM,spp_plotting,delta_perc,port_name) %>%
  # mutate(spp_plotting=paste0('~',spp_plotting,'~')) %>%
  # unite(fct,spp_plotting,port_name,sep="\n",remove=F) %>%
  # mutate(fct=factor(fct,levels=unique(fct))) %>%
  ggplot(aes(delta_perc,fill=ESM))+
  geom_density(alpha=0.5)+
  geom_vline(xintercept=0,linetype=2)+
  facet_wrap(~port_name,ncol=1)+
  # xlim(-200,200)+
  scale_color_manual(values=viridis_pal(option="D",begin=0.2,end=0.8)(3))+
  scale_fill_manual(values=viridis_pal(option="D",begin=0.2,end=0.8)(3))+
  labs(x="Percent Change in CPUE",y="",fill="",title="Change in CPUE across 100 simulations",color="")+
  guides(fill='none',color='none')+
  theme(panel.background = element_rect(fill=NA,color='black'),
        axis.text.y=element_blank(),
        axis.text.x=element_text(size=12,angle=45,vjust=0.8,hjust=0.8),
        axis.ticks.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank())
sable_reldens_fig
```