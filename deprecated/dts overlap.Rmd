---
title: "DTS projection comparison"
author: "Owen Liu"
date: "9/29/2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(magrittr)
library(lubridate)
library(rnaturalearth)
library(sf)
library(here)
library(viridis)
# vista is Eric Ward's library for looking at outputs
library(vista)
library(cowplot)
library(ggalt)
library(RANN)
library(furrr)
library(future)
library(tictoc)
library(ggsci)
library(ggpubr)

knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

```{r}
# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=12,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
pal <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
pal6 <- viridis_pal(option="C",begin=0.2,end=0.8)(6)
pal6_2 <- viridis_pal(option="B",begin=0.2,end=0.8)(6)

```

Load functions and data used for models. This command sources code and data from the `sdmTMB model functions` and `sdmTMB data construction` scripts.

```{r}
rmarkdown::render(here::here('scripts','sdmTMB model functions.Rmd'),quiet=TRUE)
```

# Landings and Value

Plot landings and value of species over time.

```{r}
landings_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T)) %>% 
  ggplot(aes(Year,tot_dollars/1e6,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Landings (Million $)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.15,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))

ppp <- v %>% mutate(ppp=Dollars/Pounds) %>% group_by(Year,lab) %>% 
  summarise(ppp=mean(ppp,na.rm=T))%>% ungroup()
ppp_plot <- ppp %>% 
  ggplot(aes(Year,ppp,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Price per Pound ($)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.1,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
ppp_plot
```

# Map of Study Area

```{r}
bbox1 <- st_bbox(projection_extent)
study_area <- ggplot()+
  geom_sf(data=coast,fill='gray80')+
  geom_sf(data=projection_extent,fill='blue',alpha=0.5,col=NA)+
  geom_sf(data=isobaths,col='black')+
  coord_sf(datum=NA)+
  xlim(bbox1[1],bbox1[3])+ylim(bbox1[2],bbox1[4])
# study_area
```

# Mean Change in Conditions

Calculate and visualize the mean change in bottom temperature and oxygen for the study area, according to the ROMS-IPSL model.

```{r}
roms_bt_oxy_ts <- roms %>% 
  dplyr::select(year,latitude,longitude,contains('30d_ipsl')) %>% 
  group_by(year) %>% 
  summarise(bt=mean(mean_bt_30d_ipsl),
            oxy=mean(mean_oxy_bottom_30d_ipsl)) %>% 
  ungroup()
roms_bt_ts_plot <- roms_bt_oxy_ts %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,bt))+
  geom_line()+
  scale_x_continuous(expand=c(0,5))+
  labs(x="Year",y="Bottom Temperature")+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12))

roms_oxy_ts_plot <- roms_bt_oxy_ts %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,oxy))+
  geom_line()+
  scale_x_continuous(expand=c(0,5))+
  labs(x="Year",y="Bottom Oxygen")+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text = element_text(size=10),
        axis.title= element_text(size=12))

bt_oxy_ts_plot <- plot_grid(roms_bt_ts_plot,roms_oxy_ts_plot,nrow=2)
# bt_oxy_ts_plot
```

```{r,fig.height=8,fig.width=8}
brow <- plot_grid(study_area,bt_oxy_ts_plot,ncol=2,labels=c('b','c'),hjust=c(-2,0.3))
intro_plot <- plot_grid(landings_plot,brow,nrow=2,rel_heights = c(0.7,1),labels=c('a',''))
intro_plot

ggsave(here('model output','dts paper','landings_and_study_area.png'),intro_plot,h=8,w=8)
```


# Model Species

Use `sdmTMB` to make ensemble models for each species of interest. (if these models have already been run, can just load them rather than running them again)

```{r,eval=F}
spp_to_model <- c("dover sole","sablefish","shortspine thornyhead","longspine thornyhead")
```

Run models and save cross-validation model stacking weights. (note: this chunk is turned to eval=F for now)

```{r,eval=F}
for(i in 1:length(spp_to_model)){
  s <- spp_to_model[i]
  m <- model_species(s,data = trawl_roms_utm,use_substrate = F)
  write_rds(m,here::here('model output','dts paper',paste(s,'models.rds')))
  print(paste(s,'models finished'))
}
```

# Produce ensemble predictions for DTS

Use IPSL ESM for now

```{r,eval=F}
dover_models <- read_rds(here::here('model output','dover sole models.rds'))
sable_models <- read_rds(here::here('model output','sablefish models.rds'))
ss_models <- read_rds(here::here('model output','shortspine thornyhead models.rds'))
ls_models <- read_rds(here::here('model output','longspine thornyhead models.rds'))

dover_ens <- ensemble_predictions(dover_models,gcm='ipsl')
sable_ens <- ensemble_predictions(sable_models,gcm='ipsl')
ss_ens <- ensemble_predictions(ss_models,gcm="ipsl")
ls_ens <- ensemble_predictions(ls_models,gcm='ipsl')

write_rds(dover_ens,here('model output','dts paper','dover_ensemble_preds_ipsl.rds'))
write_rds(sable_ens,here('model output','dts paper','sable_ensemble_preds_ipsl.rds'))
write_rds(ss_ens,here('model output','dts paper','ss_ensemble_preds_ipsl.rds'))
write_rds(ls_ens,here('model output','dts paper','ls_ensemble_preds_ipsl.rds'))
```

```{r}
dover_ens <- read_rds(here('model output','dts paper','dover_ensemble_preds_ipsl.rds'))
sable_ens <- read_rds(here('model output','dts paper','sable_ensemble_preds_ipsl.rds'))
ss_ens<-read_rds(here('model output','dts paper','ss_ensemble_preds_ipsl.rds'))
ls_ens<-read_rds(here('model output','dts paper','ls_ensemble_preds_ipsl.rds'))
```


# Ensemble Abundance

```{r,eval=F}
doverind <- make_index(dover_models,gcm = 'ipsl')
sableind <- make_index(sable_models,gcm = 'ipsl')
ssind <- make_index(ss_models,gcm = 'ipsl')
lsind <- make_index(ls_models,gcm = 'ipsl')

# ggsave(here('model output','dts paper','dover_ensemble_index_ipsl.png'),doverind,h=6,w=8)
# ggsave(here('model output','dts paper','sable_ensemble_index_ipsl.png'),sableind,h=6,w=8)
# ggsave(here('model output','dts paper','shortspine_ensemble_index_ipsl.png'),ssind,h=6,w=8)
# ggsave(here('model output','dts paper','longspine_ensemble_index_ipsl.png'),lsind,h=6,w=8)
```

# Center of Gravity

```{r,eval=F}
dover_cog <- make_cog(dover_models,gcm = 'ipsl',what="dat")
sable_cog <- make_cog(sable_models,gcm = 'ipsl',what="dat")
ss_cog <- make_cog(ss_models,gcm = 'ipsl',what="dat")
ls_cog <- make_cog(ls_models,gcm = 'ipsl',what="dat")

write_rds(dover_cog,here('model output','dts paper','dover_cog_ipsl.rds'))
write_rds(sable_cog,here('model output','dts paper','sable_cog_ipsl.rds'))
write_rds(ss_cog,here('model output','dts paper','ss_cog_ipsl.rds'))
write_rds(ls_cog,here('model output','dts paper','ls_cog_ipsl.rds'))
```

```{r}
dover_cog <- read_rds(here('model output','dts paper','dover_cog_ipsl.rds'))
sable_cog <- read_rds(here('model output','dts paper','sable_cog_ipsl.rds'))
ss_cog <-read_rds(here('model output','dts paper','ss_cog_ipsl.rds'))
ls_cog <-read_rds(here('model output','dts paper','ls_cog_ipsl.rds'))
```

```{r}
# COG figure combined
cog_all <- dover_cog %>% mutate(species="Dover") %>% 
  bind_rows(sable_cog %>% mutate(species="Sablefish")) %>% 
  bind_rows(ss_cog %>% mutate(species="Shortspine")) %>% 
  bind_rows(ls_cog %>% mutate(species="Longspine")) %>% 
  mutate(species=factor(species,levels=c("Dover","Sablefish","Shortspine","Longspine")))

fourspp_cogx_plot <- cog_all %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,w.est_x,color=species))+
  geom_line(size=1.5)+
  scale_color_manual(values=pal4,guide='none')+
  labs(x="Year",y="Eastings (km)")+
  theme(panel.background=element_rect(fill=NA,color='black'))
fourspp_cogy_plot <- cog_all %>% 
  filter(year>2019) %>% 
  ggplot(aes(year,w.est_y,color=species))+
  geom_line(size=1.5)+
  scale_color_manual(values=pal4)+
  labs(x="Year",y="Northings (km)")+
  theme(panel.background=element_rect(fill=NA,color='black'))
fourspp_cog_plot <- plot_grid(fourspp_cogx_plot,fourspp_cogy_plot,labels='auto',nrow=1,rel_widths = c(0.7,1))
ggsave(here('model output','dts paper','four_spp_cog_plot.png'),fourspp_cog_plot,h=6,w=8)
```


# Environmental Affinities

```{r}
# combined ensemble abundance
four_spp <- dover_ens %>% rename(dover=ens_est) %>% 
  left_join(sable_ens %>% rename(sable=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  left_join(ss_ens %>% rename(ss_thornyhead=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  left_join(ls_ens %>% rename(ls_thornyhead=ens_est),by = c("year", "longitude", "latitude", "lat", "lon", "depth_m")) %>% 
  # join roms data
  left_join(roms,by = c("year", "longitude", "latitude", "lat", "lon")) %>% 
  dplyr::select(year,dover:ls_thornyhead,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl,depth_m,lat,lon,longitude,latitude) %>%
  pivot_longer(dover:ls_thornyhead,names_to="species",values_to="ens_est")
```

```{r}
four_spp_sf <- four_spp %>%
      st_as_sf(coords=c("mean_bt_30d_ipsl","mean_oxy_bottom_30d_ipsl"))
tempr <- raster::raster(raster::extent(st_bbox(four_spp_sf)),nrows=150,ncol=100)
```

## Environmental Space

What are the historical and future predicted distributions of temperature-oxygen "environmental space" in the California Current? By time, space, and depth? Then we can compare these to the observed and predicted distributions of the modeled species, as well as mean environmental conditions within fishing footprints in the two time periods.

```{r}
roms_env_space <- roms %>% 
  dplyr::select(year,lat,lon,mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>% 
  distinct() %>% 
  left_join(roms_ll,by=c('lon','lat')) %>% 
  drop_na() %>% 
  rename(t=mean_bt_30d_ipsl,oxy=mean_oxy_bottom_30d_ipsl) %>% 
  mutate(depth_bin=cut(depth_m,breaks=c(0,-100,-250,-500,-1000,-3000),
                       labels=c("1000-3000m","500-1000m","250-500m","100-250m","0-100m")),
         lat_bin=cut(lat,breaks=c(30,33,36,39,42,45,48),labels=c("30-33","33-36","36-39","39-42","42-45","45-48")))
```

### Fishing footprint conditions

```{r}
bbox=st_bbox(projection_extent)
footprints_map <- ggplot()+
  geom_sf(data=footprints,aes(fill=port_name),alpha=0.5)+
  geom_sf(data=coast,fill='gray80')+
  # geom_sf(data=isobaths,col='gray20')+
  geom_sf(data=port_coords,aes(color=port_name),size=3)+
  scale_fill_npg()+
  scale_color_npg()+
  guides(color='none')+
  # guides(color="none",fill='none')+
  coord_sf(datum=NA)+
  labs(fill="Port")+
  xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
  theme(
        legend.text=element_text(size=8),
        legend.background = element_rect(fill='white',color='black'),
        legend.position=c(0.6,0.6))
footprints_map
```


```{r}
roms_env_space_sf <- roms_env_space %>% 
  filter(year%in%c(2020,2100)) %>% 
  st_as_sf(coords=c('lon','lat'),crs=4326) %>% 
  st_transform(st_crs(footprints)) %>% 
  st_join(footprints)
footprint_env_space <- roms_env_space_sf %>% 
  drop_na() %>% 
  group_by(port_name,port_group,year) %>% 
  summarise(mean_t=mean(t),mean_oxy=mean(oxy)) %>% 
  ungroup() %>% 
  pivot_wider(names_from=c(year),values_from=c(mean_t,mean_oxy)) %>% 
  mutate(delta_temp=mean_t_2100-mean_t_2020,
         delta_oxy=mean_oxy_2100-mean_oxy_2020)
```

Dumbbell plot

```{r,fig.height=8,fig.width=7.5}
# footprint_hurricane_temp_plot <- footprint_env_space %>% 
#   ggplot(aes(delta_temp,fct_rev(port_name),fill=delta_temp))+
#   geom_col(width=0.75,col='black')+
#   scale_fill_gradient(low="#FCAE91",high="#A50F15",guide='none')+
#   labs(x="Mean Temperature Change, 2020 to 2100",y="")+
#   theme(axis.text.y = element_blank())
# # footprint_hurricane_temp_plot
# 
# footprint_hurricane_oxy_plot <- footprint_env_space %>% 
#   ggplot(aes(delta_oxy,fct_rev(port_name),fill=delta_oxy))+
#   # geom_col(width=0.75,color='black')+
#   geom_point()+geom_line()+
#   scale_fill_gradient(low="#08519C",high="#EFF3FF",guide='none')+
#   labs(x="Mean Bottom Oxygen Change, 2020 to 2100",y="Port Group")
# footprint_hurricane_oxy_plot

footprint_db_temp_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_t_2020,xend=mean_t_2100,y=fct_rev(port_name)))+
  geom_dumbbell(color="#FCAE91",colour_x ="#FCAE91",colour_xend = "#A50F15",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Temperature",y="")+
  scale_y_discrete(position='right')+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text.y=element_text(color=rev(pal_npg()(6))))
footprint_db_temp_plot

footprint_db_oxy_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_oxy_2020,xend=mean_oxy_2100,y=fct_rev(port_name)))+
  geom_dumbbell(color="#a3c4dc",colour_x ="#a3c4dc",colour_xend = "#0e668b",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Oxygen",y="")+
  theme(axis.text.y = element_blank(),panel.border = element_rect(color='black',fill=NA))
footprint_db_oxy_plot
footprint_env_change_map <- plot_grid(footprints_map,NULL,footprint_db_oxy_plot,footprint_db_temp_plot,ncol=4,rel_widths = c(1,-0.2,0.5,0.7),labels=c('a','','b','c'),hjust=c(-0.5,0,-0.5,0.4))
footprint_env_change_map
ggsave(here('model output','dts paper','fishing_footprint_dumbbell_plots.png'),w=8,h=8)
```

Temperature and oxygen by depth
```{r}
t_by_depth <- roms_env_space %>% 
  filter(year %in% c(1980,2100)) %>% 
  ggplot(aes(t,depth_m,col=factor(year)))+
  geom_point()+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(2))+
  labs(x="Temperature",y="Depth",col="Year")
o_by_depth <- roms_env_space %>% 
  filter(year %in% c(1980,2100)) %>% 
  ggplot(aes(oxy,depth_m,col=factor(year)))+
  geom_point()+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(2))+
  labs(x="Oxygen (mmol/m3)",y="Depth",col="Year")
t_by_depth
o_by_depth
```

```{r}
roms_env_space_plot_facets <- roms_env_space %>% 
  drop_na() %>% 
  filter(year %in% c(2020,2100)) %>% 
  ggplot(aes(t,oxy,col=factor(year)))+
  geom_point(size=0.5)+
  facet_grid(lat_bin~depth_bin)+
  scale_color_manual(values=viridis_pal(begin=0.2,end=0.8)(2))+
  labs(col="Year",x="Bottom Temp",y="Bottom Oxygen")+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank())

roms_env_space_plot_facets
# with no facetting

bookend_env <- roms_env_space %>% 
  drop_na() %>% 
  filter(year %in% c(2020,2100))
```

Whole-domain environmental space, combined with mean change within footprints

```{r,fig.height=6,fig.width=8}
# custom_pal <- c(pal_npg()(6),"gray80","gray20")
# names(custom_pal) <- c(levels(footprint_env_space$port_name),"2020","2100")
roms_env_space_plot <- ggplot()+
  geom_point(data=bookend_env %>% filter(year==2020),aes(t,oxy),size=0.8,show.legend = c("shape"=T,"color"=F),col="gray80")+
  geom_point(data=bookend_env %>% filter(year==2100),aes(t,oxy,shape="2100"),size=0.8,show.legend = c("shape"=T,"color"=F),col="gray40",fill="gray40")+
  geom_segment(data=footprint_env_space,
               aes(x=mean_t_2020,y=mean_oxy_2020,xend=mean_t_2100,yend=mean_oxy_2100,
                   col=port_name),
               size=1.5,
               arrow=ggplot2::arrow(type="closed",length=unit(0.15,'inches')))+
  scale_color_manual(values=pal_npg()(6))+
  scale_shape_manual(values=c("2020"=16,"2100"=23))+
  # scale_shape_manual(values=c(1,16))+
  # zoom in a bit
  xlim(0,10)+ylim(0,126)+
  labs(x="Bottom Temp",y="Bottom Oxygen",col="Port Group",pch="Year")+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        legend.text = element_text(size=8),
        legend.position = c(0.3,0.85),
        legend.direction = 'horizontal',
        legend.background = element_rect(color='black'))
roms_env_space_plot
```

## Affinities (Mean + SD)

Calculate and visualize environmental affinities of the four species

```{r}
four_spp_affs <- suppressWarnings(weighted_affinities(four_spp,yrs = 1980:2020)) %>% 
  mutate(spp_plotting=case_when(
    species=='dover' ~ "Dover Sole",
    species=="ls_thornyhead" ~ "Longspine",
    species=="ss_thornyhead"~"Shortspine",
    species=="sable" ~"Sablefish"
  )) %>% 
  mutate(spp_plotting=factor(spp_plotting,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

roms_env_space_plot2 <- ggplot()+
  geom_point(data=bookend_env %>% filter(year==2020),aes(t,oxy),size=0.8,show.legend = c("shape"=T,"color"=F),col="gray80")+
  geom_point(data=bookend_env %>% filter(year==2100),aes(t,oxy,shape="2100"),size=0.8,show.legend = c("shape"=T,"color"=F),col="gray40",fill='gray40')+
  geom_pointrange(data=four_spp_affs,aes(x=w.t,y=w.o,xmin=t.q5,xmax=t.q95,col=spp_plotting))+
  geom_pointrange(data=four_spp_affs,aes(x=w.t,y=w.o,ymin=o.q5,ymax=o.q95,col=spp_plotting))+
  scale_color_manual(values=pal)+
  scale_shape_manual(values=c("2020"=16,"2100"=23),guide=guide_legend(override.aes = list(color=c("gray80","gray40"))))+
  xlim(0,10)+ylim(0,126)+
  labs(pch="Year",col="Species",x="Bottom Temp",y="Bottom Oxygen")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.text = element_text(size=8),
        legend.position = c(0.3,0.85),
        legend.direction = 'horizontal',
        legend.background = element_rect(color='black'))

# roms_env_space_plot2
```

```{r,fig.height=8,fig.width=8}
env_space_plots <- plot_grid(roms_env_space_plot2,roms_env_space_plot,nrow=2,labels='auto')
env_space_plots
```

## Affinities (Concave Hull)

```{r}
library(ggnewscale)
aff_polys<-affinities_ellipses(four_spp,yr_vec=1980:2020,concavity=7,threshold=0.25)
# plotting order for colors
polys_and_footprints <- ggplot()+
  geom_polygon(data=aff_polys,aes(V1,V2,col=spp_plotting),fill=NA,size=1,linetype=3)+
  scale_color_manual(values=c(pal4),name="Top 75% of\nspecies' CPUE")+
  new_scale_color()+
  geom_segment(data=footprint_env_space,aes(x=mean_t_2020,y=mean_oxy_2020,xend=mean_t_2100,yend=mean_oxy_2100,
             col=port_name),size=1,linetype=1,arrow=ggplot2::arrow(type="open",length=unit(0.1,'inches')))+
  scale_color_npg(name="Port Group\nClimate")+
  labs(x="Bottom Temperature (deg C)",y="Bottom Oxygen (mmol/m3)")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        panel.border = element_rect(color='black',fill=NA),
        axis.text=element_text(size=12))
```

```{r,fig.width=8,fig.height=8}
# attach dumbbell plots
footprint_db_temp_plot2 <- footprint_env_space %>% 
  ggplot(aes(x=mean_t_2020,xend=mean_t_2100,y=port_name))+
  geom_dumbbell(color="#FCAE91",colour_x ="#FCAE91",colour_xend = "#A50F15",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Temperature",y="")+
  coord_flip()+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text.x=element_text(color=pal_npg()(6),size=10))

footprint_db_oxy_plot2 <- footprint_env_space %>% 
  ggplot(aes(x=mean_oxy_2020,xend=mean_oxy_2100,y=port_name))+
  geom_dumbbell(color="#a3c4dc",colour_x ="#a3c4dc",colour_xend = "#0e668b",
                size=1,size_x=3,size_xend = 3) +
  labs(x="Oxygen",y="")+
  coord_flip()+
  theme(axis.text.x = element_blank(),panel.border = element_rect(color='black',fill=NA))

fig2 <- plot_grid(footprint_db_temp_plot2,footprint_db_oxy_plot2,polys_and_footprints,labels='auto',nrow=3,
                  hjust = 0,vjust=1,
                  rel_heights = c(0.2,0.2,0.6))
fig2
ggsave(here('model output','dts paper','fig2.png'),fig2,h=8,w=8)
```


## Affinities (Heatmap)

Calculate and visualize environmental affinities of the four species.

```{r,fig.height=4,fig.width=8}
four_spp_r <- four_spp %>% 
  filter(year>=1980,year<=2010) %>% 
  group_split(species) %>% 
  purrr::map(rasterize_affinities,template_raster=tempr) %>% 
  set_names(unique(four_spp$species))

ylab <- text_grob("Oxygen",rot=90)
xlab <- text_grob("Temperature",just = "center")
leg <- four_spp %>% filter(species=="dover") %>% rasterize_affinities(template_raster=tempr,return_what="legend")
xrow <- plot_grid(NULL,NULL,xlab,NULL,nrow=1,rel_widths=c(0.1,1,1,1))
  
four_spp_affinities <-plot_grid(plotlist = list(ylab,four_spp_r[[1]],four_spp_r[[2]],NULL,four_spp_r[[3]],four_spp_r[[4]],leg,NULL,NULL,NULL,xlab,NULL,NULL),nrow=2,ncol=7,rel_widths=c(0.1,1,1,0.1,1,1,0.5),rel_heights = c(1,0.1),labels = c("","a","b","","c","d",""))

four_spp_affinities
ggsave(here('model output','dts paper','four species affinities.png'),four_spp_affinities,w=8,h=4)
```

# Depth Change

```{r}
fourspp_depth <- plot_depth_distribution2(four_spp,start_year = 2020,end_year=2100)+theme(panel.background = element_rect(fill=NA,color='black'))+theme(legend.position = 'bottom')
fourspp_depth
ggsave(here('model output','dts paper','fig_depth_change_four_spp.png'),fourspp_depth,w=6,h=4)
```


```{r,fig.height=8,fig.width=8}
doverdepth <- plot_depth_distribution(dover_ens,name="Dover Sole")
sabledepth <- plot_depth_distribution(sable_ens,name="Sablefish")
ssdepth <- plot_depth_distribution(ss_ens,name="Shortspine")
lsdepth <- plot_depth_distribution(ls_ens,name="Longspine")
four_spp_depths <- plot_grid(doverdepth,sabledepth,ssdepth,lsdepth,nrow=2,labels="auto")

# add fishy icons
plt <- ggdraw()+
  draw_plot(four_spp_depths)+
  draw_image(here('data','icons','dover1.jpg'),hjust=.27,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','sablefish.png'),hjust=-.26,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','shortspine.png'),hjust=.24,vjust=.3,scale=0.15)+
  draw_image(here('data','icons','longspine1.jpg'),hjust=-.26,vjust=.3,scale=0.15)
plt

ggsave(here('model output','dts paper','four species depth distribution.png'),plt,w=8,h=8)
```

# Distance from Shore

Weighted distance from shore
```{r}
four_spp_dist <- plot_dist_to_shore_change(four_spp,include_legend = F)
four_spp_dist
ggsave(here('model output','dts paper','four species distance from shore.png'),four_spp_dist,w=6,h=6)
```

With depth plot as well

```{r,fig.width=7,fig.height=5}
leg <- get_legend(fourspp_depth)
fig_dist_depth_change<-plot_grid(four_spp_dist+theme(plot.margin=unit(c(0.5,0.5,1.5,0.5),'cm')),
                                 fourspp_depth+guides(color='none')+theme(plot.margin=unit(c(0.5,0.5,1.5,0.5),'cm')),
                                 nrow=1,labels='auto')
fig_dist_depth_change<-ggdraw()+
  draw_plot(fig_dist_depth_change)+
  draw_plot(leg,y=-0.45)
# fig_dist_depth_change<-plot_grid(four_spp_dist,fourspp_depth+guides(color='none'),NULL,NULL,leg,NULL,nrow=3,rel_heights=c(1,-0.2,0.5),labels=c('a','b','','','',''))

ggsave(here('model output','dts paper','fig_dist_depth_change.png'),fig_dist_depth_change,w=8,h=5)
```



```{r,fig.width=8,fig.height=6}
# dover_dist <- plot_dist_to_shore_change(dover_ens,include_legend = F)
# sable_dist <- plot_dist_to_shore_change(sable_ens,include_legend = F)
# ss_dist <- plot_dist_to_shore_change(ss_ens,include_legend = F)
# ls_dist <- plot_dist_to_shore_change(ls_ens,include_legend = F)
# 
# ylab <- text_grob("Latitude",rot=90)
# xlab <- text_grob("Change in Distance from Shore (km)",vjust = -2)
# distleg <- dover_ens %>% plot_dist_to_shore_change(include_legend=T) %>% ggpubr::get_legend()
# 
# 
# four_spp_dist <- plot_grid(ylab,dover_dist,sable_dist,NULL,ss_dist,ls_dist,distleg,NULL,NULL,NULL,xlab,NULL,NULL,NULL,ncol=7,
#                            labels=c("",'a',"b","","c","d",""),
#                            rel_widths = c(0.1,1,1,0.1,1,1,0.5),
#                            rel_heights = c(1,0.1))
# four_spp_dist
# ggsave(here('model output','dts paper','four species distance from shore.png'),four_spp_dist,w=8,h=6)
```

```{r,fig.width=8,fig.height=6}
dover_distmap <- map_dist_to_shore(dover_ens,include_legend = F)
sable_distmap <- map_dist_to_shore(sable_ens,include_legend = F)
ss_distmap <- map_dist_to_shore(ss_ens,include_legend = F)
ls_distmap <- map_dist_to_shore(ls_ens,include_legend = F)

ylab <- text_grob("Latitude",rot=90)
xlab <- text_grob("Distribution Centroid",vjust = -5)
distmapleg <- dover_ens %>% map_dist_to_shore(include_legend=T) %>% ggpubr::get_legend()


four_spp_distmap <- plot_grid(ylab,dover_distmap,sable_distmap,NULL,ss_distmap,ls_distmap,distmapleg,NULL,NULL,NULL,xlab,NULL,NULL,NULL,ncol=7,
                           labels=c("",'a',"b","","c","d",""),
                           rel_widths = c(0.1,1,1,0.1,1,1,0.5),
                           rel_heights = c(1,0.05))
four_spp_distmap
ggsave(here('model output','dts paper','four species distance from shore map.png'),four_spp_distmap,w=8,h=6)
```

# Zonal CPUE Change

```{r}
zonal_cpue_change <- plot_mean_zonal_cpue_change(four_spp)
zonal_rel_cpue_change <- plot_rel_zonal_cpue_change(four_spp)
zonal_cpue_change
zonal_rel_cpue_change

ggsave(here('model output','dts paper','zonal_mean_cpue_change.png'),zonal_cpue_change,w=6,h=6)
ggsave(here('model output','dts paper','zonal_rel_cpue_change.png'),zonal_rel_cpue_change,w=6,h=6)

```

# Hovmoller Plots

As another way to show the expected changes in depth and abundance across space, show Hovmoller-type plots

```{r,fig.height=6,fig.width=8}
dover_hov <- make_hov(dover_models,gcm="ipsl")
sable_hov <- make_hov(sable_models,gcm="ipsl")
ss_hov <- make_hov(ss_models,gcm="ipsl")
ls_hov <- make_hov(ls_models,gcm="ipsl")

dover_hov
sable_hov
ss_hov
ls_hov

ggsave(here('model output','dts paper','dover sole hovmoller.png'),dover_hov,w=8,h=6)
ggsave(here('model output','dts paper','sablefish hovmoller.png'),sable_hov,w=8,h=6)
ggsave(here('model output','dts paper','shortspine hovmoller.png'),ss_hov,w=8,h=6)
ggsave(here('model output','dts paper','longspine hovmoller.png'),ls_hov,w=8,h=6)
```


# Maps

```{r,fig.height=10,fig.width=7}
dover2021_map <- map_year(dover_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
sable2021_map <- map_year(sable_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
ss2021_map <- map_year(ss_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)
ls2021_map <- map_year(ls_ens,yr_vec=1980:2021,return_pred_df=F,plot_leg = F)

plot_grid(dover2021_map,sable2021_map,ss2021_map,ls2021_map,nrow=2,labels='auto')

dover2100_map <- map_year(dover_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
sable2100_map <- map_year(sable_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
ss2100_map <- map_year(ss_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
ls2100_map <- map_year(ls_ens,yr_vec=2080:2100,return_pred_df=F,plot_leg = F)
plot_grid(dover2100_map,sable2100_map,ss2100_map,ls2100_map,nrow=2,labels='auto')
```

Overlap map (count number of species in each cell). This figure shows the number of species out of four in each grid cell that are at or above their median CPUE (across all cells) for that year.

```{r,fig.width=6,fig.height=8}
# include footprints
multimap2020 <- map_multispp_year(four_spp,yr=2020,qlower=0.75,qupper=1)+guides(fill='none')
multimap2100 <- map_multispp_year(four_spp,yr=2100,qlower=0.75,qupper=1)
partb <- plot_grid(multimap2020,NULL,multimap2100,rel_widths = c(1,-0.65,1),nrow=1,labels=c('2020','','2100'),
                  hjust=-2,vjust=2)
row2 <- plot_grid(footprints_map,partb,labels=c('b','c'),nrow=1,rel_widths = c(0.8,1))
multimapcomp <- plot_grid(landings_plot,row2,nrow=2,rel_heights = c(0.3,0.7),labels='auto')

multimap2020
multimap2100

ggsave(here('model output','dts paper','footprint_spp_presence_rast_2020.png'),multimap2020,w=6,h=8)
ggsave(here('model output','dts paper','footprint_spp_presence_rast_2100.png'),multimap2100,w=6,h=8)

ggsave(here('model output','dts paper','fig1.png'),multimapcomp,w=6,h=8)
```
```{r}
# count cells
x <- four_spp %>% 
     filter(year==2020) %>% 
     # find quantiles for each species
     group_by(species) %>% 
     mutate(qlow=quantile(ens_est,0.75),qhigh=quantile(ens_est,1)) %>% 
     mutate(presence=ifelse(ens_est>=qlow&ens_est<=qhigh,1,0)) %>% 
     ungroup() %>% 
     group_by(longitude,latitude) %>% 
     summarise(sumspp=sum(presence))

y <- four_spp %>% 
     filter(year==2100) %>% 
     # find quantiles for each species
     group_by(species) %>% 
     mutate(qlow=quantile(ens_est,0.75),qhigh=quantile(ens_est,1)) %>% 
     mutate(presence=ifelse(ens_est>=qlow&ens_est<=qhigh,1,0)) %>% 
     ungroup() %>% 
     group_by(longitude,latitude) %>% 
     summarise(sumspp=sum(presence))

x %>% ggplot(aes(sumspp))+geom_histogram(bins=5)+labs(x="Number of Overlapping Species",y="Count",title="2020")
y %>% ggplot(aes(sumspp))+geom_histogram(bins=5)+labs(x="Number of Overlapping Species",y="Count",title="2100")
```


# Calculate Overlap Over Time

Schoener's D measures spatial niche overlap, or how two species use space relative to its availability.

$$D = 1 - 0.5*\sum_{1}^{n}{|p_{1,i}-p_{2,i}|}$$


Also calculating an index of local collocation, 

$$ L = \frac{\sum_{1}^{n}{p_{1,i}}*p_{2,i}}{\sqrt{{\sum_{1}^{n}p_{1,i}^2}{\sum_{1}^{n}p_{2,i}^2}}}$$
which describes the correlation between two ranges. It ranges between 0 and 1 and can be thought of as the ratio of the probability of finding two species in the same area to the total probability of finding either species.

...and an index of global collocation, from Bez and Rivoirard (2000) and Carroll et al. (2019), measuring more regional-scale overlap by comparing centers of gravity and inertia/dispersion of each species' range.

```{r}
ens_est_overlaps <- dover_ens %>% nest(dover = c(longitude, latitude, lat, lon, depth_m, ens_est)) %>% 
  # join all the data and cogs nested by year
  left_join(sable_ens %>% nest(sable = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(ss_ens %>% nest(ss = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(ls_ens %>% nest(ls = c(longitude, latitude, lat, lon, depth_m, ens_est)),by = "year") %>% 
  left_join(dover_cog %>% nest(dover_cog=c(w.est_x,w.est_y)),by = "year")%>% 
  left_join(sable_cog %>% nest(sable_cog=c(w.est_x,w.est_y)),by = "year")%>% 
  left_join(ss_cog %>% nest(ss_cog=c(w.est_x,w.est_y)),by = "year") %>%  
  left_join(ls_cog %>% nest(ls_cog=c(w.est_x,w.est_y)),by = "year") %>% 
  
  # calculate the gic
  mutate(dover_sable_gic=purrr::pmap_dbl(list(dat1=dover,dat2=sable,cog1=dover_cog,cog2=sable_cog),gic)) %>%
  mutate(dover_ss_gic=purrr::pmap_dbl(list(dat1=dover,dat2=ss,cog1=dover_cog,cog2=ss_cog),gic)) %>% 
  mutate(dover_ls_gic=purrr::pmap_dbl(list(dat1=dover,dat2=ls,cog1=dover_cog,cog2=ls_cog),gic)) %>% 
  mutate(sable_ss_gic=purrr::pmap_dbl(list(dat1=sable,dat2=ss,cog1=sable_cog,cog2=ss_cog),gic)) %>% 
  mutate(sable_ls_gic=purrr::pmap_dbl(list(dat1=sable,dat2=ls,cog1=sable_cog,cog2=ls_cog),gic)) %>% 
  mutate(ss_ls_gic=purrr::pmap_dbl(list(dat1=ss,dat2=ls,cog1=ss_cog,cog2=ls_cog),gic)) %>% 
  
  # calculate Schoener's D
  mutate(dover_sable_sch=purrr::pmap_dbl(list(dat1=dover,dat2=sable),schoeners)) %>% 
  mutate(dover_ss_sch=purrr::pmap_dbl(list(dat1=dover,dat2=ss),schoeners)) %>% 
  mutate(dover_ls_sch=purrr::pmap_dbl(list(dat1=dover,dat2=ls),schoeners)) %>% 
  mutate(sable_ss_sch=purrr::pmap_dbl(list(dat1=sable,dat2=ss),schoeners)) %>% 
  mutate(sable_ls_sch=purrr::pmap_dbl(list(dat1=sable,dat2=ls),schoeners)) %>% 
  mutate(ss_ls_sch=purrr::pmap_dbl(list(dat1=ss,dat2=ls),schoeners)) %>% 
  
  # calculate local colocation
  mutate(dover_sable_loc=purrr::pmap_dbl(list(dat1=dover,dat2=sable),lic)) %>% 
  mutate(dover_ss_loc=purrr::pmap_dbl(list(dat1=dover,dat2=ss),lic)) %>% 
  mutate(dover_ls_loc=purrr::pmap_dbl(list(dat1=dover,dat2=ls),lic)) %>%
  mutate(sable_ss_loc=purrr::pmap_dbl(list(dat1=sable,dat2=ss),lic)) %>%  
  mutate(sable_ls_loc=purrr::pmap_dbl(list(dat1=sable,dat2=ls),lic)) %>% 
  mutate(ss_ls_loc=purrr::pmap_dbl(list(dat1=ss,dat2=ls),lic))

```

## Local Index of Co-location

```{r}
lic_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_loc:ss_ls_loc) %>% 
  pivot_longer(dover_sable_loc:ss_ls_loc,values_to='loc') %>% 
  mutate(lab=case_when(
    name=="dover_sable_loc" ~ "Dover Sole/Sablefish",
    name=="dover_ss_loc" ~ "Dover Sole/Shortspine",
    name=="dover_ls_loc" ~ "Dover Sole/Longspine",
    name=="sable_ss_loc" ~ "Sablefish/Shortspine",
    name=="sable_ls_loc" ~ "Sablefish/Longspine",
    name=="ss_ls_loc" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,loc,col=lab))+
  geom_line(size=1)+
  scale_y_continuous(limits=c(NA,1))+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  theme(legend.background = element_rect(color='black'),
        legend.text = element_text(size=12),
        panel.background=element_rect(fill=NA,color='black'))+
  labs(x="Year",y="Local Index of Collocation",color="Species Pair")
lic_plot
ggsave(here('model output','dts paper','four species LIC.png'),lic_plot,w=8,h=6)
```

```{r,fig.height=4,fig.width=4}
# a different way to represent this
lic_plot2 <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_loc:ss_ls_loc) %>% 
  pivot_longer(dover_sable_loc:ss_ls_loc,values_to='loc') %>% 
  mutate(lab=case_when(
    name=="dover_sable_loc" ~ "Dover Sole/Sablefish",
    name=="dover_ss_loc" ~ "Dover Sole/Shortspine",
    name=="dover_ls_loc" ~ "Dover Sole/Longspine",
    name=="sable_ss_loc" ~ "Sablefish/Shortspine",
    name=="sable_ls_loc" ~ "Sablefish/Longspine",
    name=="ss_ls_loc" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year %in% c(2020,2100)) %>%  
  group_by(name,lab) %>% 
  mutate(diff=loc[year==2100]-loc[year==2020]) %>% 
  mutate(baseline=loc[year==2020]) %>%
  ungroup() %>% 
  dplyr::select(-year,-loc) %>% 
  distinct() %>% 
  mutate(lab=forcats::fct_reorder(lab,diff)) %>% 
  ggplot(aes(diff,lab,fill=baseline))+
  geom_col(width=1)+
  scale_fill_viridis(option="A",begin=0.2,end=0.8)+
  geom_vline(xintercept = 0,size=1)+
  theme(legend.background = element_rect(color='black'),
        legend.position=c(0.2,0.75),
        panel.border = element_rect(color='black',fill=NA),
        legend.text = element_text(size=12),
        panel.grid.minor = element_blank(),
        panel.grid.major.x=element_blank())+
  labs(x="Change in L, 2020 to 2100",y="",fill="2020 L")
lic_plot2
ggsave(here('model output','dts paper','four species LIC_2.png'),lic_plot2,w=4,h=4.5)
```

## Global Index of Co-location

```{r}
gic_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_gic:ss_ls_gic) %>% 
  pivot_longer(dover_sable_gic:ss_ls_gic,values_to='gic') %>% 
  mutate(lab=case_when(
    name=="dover_sable_gic" ~ "Dover Sole/Sablefish",
    name=="dover_ss_gic" ~ "Dover Sole/Shortspine",
    name=="dover_ls_gic" ~ "Dover Sole/Longspine",
    name=="sable_ss_gic" ~ "Sablefish/Shortspine",
    name=="sable_ls_gic" ~ "Sablefish/Longspine",
    name=="ss_ls_gic" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,gic,col=lab))+
  geom_line(size=1)+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  scale_y_continuous(limits = c(0.8,1))+
  theme(legend.background = element_rect(color='black'),
        panel.background=element_rect(fill=NA,color='black'))+
  labs(x="Year",y="Global Index of Collocation",color="Species Pair")
gic_plot

ggsave(here('model output','dts paper','four species GIC.png'),gic_plot,w=8,h=6)
```

## Schoener's D

```{r}
D_plot <- ens_est_overlaps %>% 
  dplyr::select(year,dover_sable_sch:ss_ls_sch) %>% 
  pivot_longer(dover_sable_sch:ss_ls_sch,values_to='sch') %>% 
  mutate(lab=case_when(
    name=="dover_sable_sch" ~ "Dover Sole/Sablefish",
    name=="dover_ss_sch" ~ "Dover Sole/Shortspine",
    name=="dover_ls_sch" ~ "Dover Sole/Longspine",
    name=="sable_ss_sch" ~ "Sablefish/Shortspine",
    name=="sable_ls_sch" ~ "Sablefish/Longspine",
    name=="ss_ls_sch" ~ "Shortspine/Longspine"
  )) %>% 
  filter(year>2020) %>% 
  ggplot(aes(x=year,sch,col=lab))+
  geom_line(size=1)+
  scale_y_continuous(limits=c(NA,1))+
  scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),
                     guide=guide_legend(override.aes = list(size=2)))+
  theme(legend.background = element_rect(color='black'),
        panel.background=element_rect(fill=NA,color='black'))+
  labs(x="Year",y="Schoener's D",color="Species Pair")

D_plot

ggsave(here('model output','dts paper','four species D.png'),D_plot,w=8,h=6)
```

## All Together

```{r,fig.width=8,fig.height=8}
overlap_legend <- get_legend(lic_plot)
lic_noleg <- lic_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')
gic_noleg <- gic_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')
D_noleg <- D_plot+scale_color_manual(values=viridis_pal(option="A",begin=0.2,end=0.8)(6),guide='none')

overlap_plots <- plot_grid(gic_noleg,lic_noleg,D_noleg,overlap_legend,nrow=2,labels=c('a','b','c',''))
overlap_plots
ggsave(here('model output','dts paper','species_overlap_metrics.png'),overlap_plots,w=8,h=8)
```

# DTS Footprints

We can use fishing data to look at climatic and predicted species abundance and overlap changes within historical (2011-2015) fishing footprints for DTS. From Becca Selden, 12/09/2021:

Communities were defined as all trips returning to a specific IOPAC port group. All fishing trips associated with the community that caught dover sole, thornyhead, and sablefish were extracted from PACFIN. Total quantity landed was aggregated across species for each trip. The latitude and longitude coordinates were converted to the Mercator projection UTM Zone 10 to allow for more accurate estimates of area and overlap. A weighted kernel density surface was created from the point estimates of catch for the focal period with a 10 km bandwidth, using the density.ppp function in the sp package in R. The footprint of the community was defined using a percent volume contour that represents the boundary of the area that contains 75% of the volume of the kernel density distribution using the `getvolumeUD` function in the `adehabitat` package in R.

## Predicted Species Abundance

Using sdmTMB ensemble model outputs, calculate changing mean species densities within DTS footprints.

### Mean CPUE Time Series

Calculate the mean CPUE and mean CPUE change within each footprint, for each species, over time

```{r,fig.height=8,fig.width=5}
footprint_ts <- purrr::map2_df(list(dover_ens,sable_ens,ss_ens,ls_ens),c("Dover Sole","Sablefish","Shortspine","Longspine"),function(x,y)calc_footprint_dens_ts(x,what="df") %>% mutate(species=y)) %>% 
  mutate(species=factor(species,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

pal4 <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
footprint_ts_plot <- footprint_ts %>% 
  ggplot(aes(year,mean_log_cpue,col=species))+
  geom_line(size=1)+
  labs(x="Year",y="Log CPUE (kg per sq. km)",color="Species")+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,0))+
  facet_wrap(~port_name,ncol=1,scales='free_y')+
  theme(legend.position = "left",
        axis.text=element_text(size=10),
        panel.border = element_rect(color='black',fill=NA),
        axis.text.x = element_text(angle=45,hjust=0.7),
        plot.margin = unit(c(0.1,0.5,0.1,0.1),'cm'))
footprint_ts_plot

ggsave(here('model output','dts paper','footprint_cpue_ts.png'),footprint_ts_plot,w=8,h=6)
```

```{r,fig.height=8,fig.width=4}
footprint_reldens_ts<-purrr::map2_df(list(dover_ens_all,sable_ens_all,ss_ens_all,ls_ens_all),c("Dover Sole","Sablefish","Shortspine","Longspine"),function(x,y)calc_footprint_reldens_ts(x,what="df") %>% mutate(species=y)) %>% 
  mutate(species=factor(species,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

footprint_reldens_ts_plot <- footprint_reldens_ts %>% 
  ggplot(aes(year,perc_change,col=species))+
  geom_line(size=1)+
  # ggplot(aes(year,perc_change,col=species,size=mean_cpue/5500*3))+
  # geom_line()+
  geom_hline(yintercept=0,col='black')+
  labs(x="Year",y="Mean CPUE Change Relative to 2020 (%)",color="Species")+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,0))+
  guides(color='none')+
  facet_wrap(~port_name,ncol=1,scales='free_y')+
  theme(legend.position = "left",
        axis.text=element_text(size=10),
        panel.border = element_rect(color='black',fill=NA),
        axis.text.x = element_text(angle=45,hjust=0.7),
        plot.margin = unit(c(0.1,0.5,0.1,0.1),'cm'))
footprint_reldens_ts_plot

ggsave(here('model output','dts paper','footprint_rel_cpue_ts.png'),footprint_reldens_ts_plot,w=6,h=8)
```

```{r,fig.height=8,fig.width=6}
# combined log cpue and relative density timeseries
sppleg <- get_legend(footprint_ts_plot+theme(legend.background = element_rect(color='black'),
                                             legend.margin = margin(c(0.1,0.5,0.1,0.2),'cm'),
                                             legend.text = element_text(size=8)))
footprint_ts_cpue_reldens <- plot_grid(footprint_ts_plot+guides(color='none'),footprint_reldens_ts_plot,sppleg,ncol=3,rel_widths = c(1,1,0.5),labels=c('a','b',''))
footprint_ts_cpue_reldens
ggsave(here('model output','dts paper', 'footprint_cpue_relcpue_ts.png'),w=6,h=8)
```

```{r}
footprint_ts_plot_with_map <- plot_grid(footprint_reldens_ts_plot,footprints_map,ncol=2)
footprint_ts_plot_with_map
ggsave(here('model output','dts paper','footprints_cpue_ts_map.png'),footprint_ts_plot_with_map,h=8,w=8)
```

### LIC Time Series

Calculate the total (sum) local index of collocation within footprints, over time.

```{r}
#for all species pairs
lic_footprints_all <- list(
  dover_sable_lic_footprints <- calc_footprint_overlap_ts(dover_ens,sable_ens) %>% mutate(spp1='dover',spp2='sable'),
  dover_ss_lic_footprints <- calc_footprint_overlap_ts(dover_ens,ss_ens) %>% mutate(spp1='dover',spp2='shortspine'),
  dover_ls_lic_footprints <- calc_footprint_overlap_ts(dover_ens,ls_ens) %>% mutate(spp1='dover',spp2='longspine'),
  sable_ss_lic_footprints <- calc_footprint_overlap_ts(sable_ens,ss_ens) %>% mutate(spp1='sable',spp2='shortspine'),
  sable_ls_lic_footprints <- calc_footprint_overlap_ts(sable_ens,ls_ens) %>% mutate(spp1='sable',spp2='longspine'),
  ss_ls_lic_footprints <- calc_footprint_overlap_ts(ss_ens,ls_ens) %>% mutate(spp1='shortspine',spp2='longspine')
) %>% bind_rows()
```

```{r}
# lic_footprints_all_plot <- lic_footprints_all %>% 
#   mutate(spp1=factor(spp1,levels=c('dover','sable','shortspine','longspine')),
#          spp2=factor(spp2,levels=c('dover','sable','shortspine','longspine'))) %>% 
#   filter(year%in%c(2020,2100)) %>% 
#   # complete(nesting(year,port_name),spp1,spp2) %>% 
#   # filter(spp1!=spp2) %>% 
#   group_by(port_name,spp1,spp2) %>% 
#   summarise(delta_lic=sum_lic[year==2100]-sum_lic[year==2020]) %>% 
#   ggplot(aes(spp1,spp2,fill=delta_lic))+
#   geom_tile(color='black')+
#   facet_wrap(~port_name,ncol = 1)+
#   scale_fill_gradient2(na.value = "gray80")+
#   labs(x="Species 1",y="Species 2",fill="\u0394LIC")+
#   theme(panel.border = element_rect(color='black',fill=NA),
#         panel.grid.major=element_blank(),
#         panel.grid.minor=element_blank(),
#         panel.background = element_rect(fill='gray80'))
# lic_footprints_all_plot
# 
# ggsave(here('model output','dts paper','footprints_lic_tiles.png'),lic_footprints_all_plot,h=8,w=4)
```

```{r,fig.height=20,fig.width=6}
# library(ggh4x)
# lic_footprints_all_plot <- lic_footprints_all %>% 
#   mutate(spp1=factor(spp1,levels=c('dover','sable','shortspine','longspine')),
#          spp2=factor(spp2,levels=c('dover','sable','shortspine','longspine'))) %>%
#   filter(year>=2020) %>% 
#   ggplot(aes(year,sum_lic))+
#   geom_point(alpha=0.5)+
#   geom_smooth(se=F)+
#   facet_nested_wrap(~port_name+spp1+spp2,scales='free_y',dir='v')
# lic_footprints_all_plot

# make_lic_footprint_plot <- function(licdat,port){
#   out <- licdat %>% 
#     filter(year>=2020,port_name==port) %>% 
#     group_by(spp1,spp2) %>% 
#     mutate(anom=sum_lic-sum_lic[year==2020]) %>%  
#     mutate(spp1=case_when(
#       spp1=="dover"~"Dover",
#       spp1=="sable"~"Sablefish",
#       spp1=="shortspine"~"Shortspine",
#       spp1=="longspine"~"Longspine"
#     )) %>% 
#     mutate(spp2=case_when(
#       spp2=="dover"~"Dover",
#       spp2=="sable"~"Sablefish",
#       spp2=="shortspine"~"Shortspine",
#       spp2=="longspine"~"Longspine"
#     )) %>% 
#     mutate(spp1=factor(spp1,levels=c('Dover','Sablefish','Shortspine','Longspine')),
#            spp2=factor(spp2,levels=c('Dover','Sablefish','Shortspine','Longspine'))) %>%
#     ggplot(aes(year,anom))+
#     geom_point(alpha=0.5)+
#     geom_smooth(se=F)+
#     geom_hline(yintercept=0,linetype=2)+
#     labs(x="Year",y="\u0394LIC",title=port)+
#     theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
#           panel.border = element_rect(fill=NA,color='black'))+
#     facet_wrap2(spp2~spp1,nrow=3,drop=TRUE)
# 
#   out
# }
# lic_footprints_all_plot <- purrr::map(unique(lic_footprints_all$port_name),make_lic_footprint_plot,licdat=lic_footprints_all) %>% 
#   plot_grid(plotlist = .,ncol=1)
# lic_footprints_all_plot
```

```{r}
# licdat=lic_footprints_all;s1='sable';s2='shortspine';port='Astoria'
# make_single_lic_comp <- function(licdat,s1,s2,port){
#   out <- licdat %>% 
#     filter(year>=2020,port_name==port,spp1==s1,spp2==s2) %>%
#     mutate(anom=sum_lic-sum_lic[year==2020]) %>%
#     mutate(spp1=case_when(
#       spp1=="dover"~"Dover",
#       spp1=="sable"~"Sablefish",
#       spp1=="shortspine"~"Shortspine",
#       spp1=="longspine"~"Longspine"
#     )) %>%
#     mutate(spp2=case_when(
#       spp2=="dover"~"Dover",
#       spp2=="sable"~"Sablefish",
#       spp2=="shortspine"~"Shortspine",
#       spp2=="longspine"~"Longspine"
#     )) %>%
#     mutate(spp1=factor(spp1,levels=c('Dover','Sablefish','Shortspine','Longspine')),
#            spp2=factor(spp2,levels=c('Dover','Sablefish','Shortspine','Longspine'))) %>%
#     ggplot(aes(year,anom))+
#     geom_point(alpha=0.5)+
#     geom_smooth(se=F)+
#     ylim(-0.15,0.05)+
#     geom_hline(yintercept=0,linetype=2)+
#     theme_void()+
#     theme(panel.background=element_rect(fill=NULL,color='black'))
#   
#   out
# }
# make_single_lic_comp(lic_footprints_all,s1='sable',s2='shortspine',port='Astoria')
# #make all
# lic_plts <- lic_footprints_all %>% 
#   distinct(spp1,spp2,port_name) %>% 
#   rename(s1=spp1,s2=spp2,port=port_name) %>% 
#   mutate(p=purrr::pmap(.,make_single_lic_comp,licdat=lic_footprints_all))
# ls <- list(lic_plts$p[[1]],lic_plts$p[[7]],lic_plts$p[[13]],lic_plts$p[[19]],lic_plts$p[[25]],NULL,lic_plts$p[[31]],NULL,NULL)
# plot_grid(plotlist=ls,nrow=3,ncol=3,byrow=T)
```


Try another visualization (facetted time series)

```{r,fig.width=4,fig.height=8}
# lic_footprints_all_facets <- lic_footprints_all %>% 
#   filter(year>=2020) %>% 
#   mutate(spp1=case_when(
#     spp1=="dover"~"D",
#     spp1=="sable"~"S",
#     spp1=="shortspine"~"SS",
#     spp1=="longspine"~"LS"
#   )) %>% 
#   mutate(spp1=factor(spp1,levels=c("D","S","SS","LS"))) %>% 
#   mutate(spp2=case_when(
#     spp2=="dover"~"D",
#     spp2=="sable"~"S",
#     spp2=="shortspine"~"SS",
#     spp2=="longspine"~"LS"
#   )) %>% 
#   mutate(spp1=factor(spp1,levels=c("D","S","SS","LS"))) %>% 
#   group_by(port_name,spp1,spp2) %>% 
#   mutate(anomaly=sum_lic-sum_lic[year==2020]) %>% 
#   ungroup() %>% 
#   group_split(port_name) %>%
#   map(function(df){
#     df %>% 
#       ggplot(aes(year-2000,anomaly))+
#       geom_line(size=1)+
#       geom_hline(yintercept=0,linetype=2)+
#       facet_wrap(spp2~spp1)+
#       labs(x="Year",y="\u0394LIC")+
#       theme(panel.grid.major = element_blank(),
#             panel.grid.minor=element_blank())
#   })
# lic_footprints_all_plot2 <- plot_grid(plotlist=lic_footprints_all_facets,labels=levels(lic_footprints_all$port_name),ncol=1,vjust = 0)
# lic_footprints_all_plot2
```

```{r,fig.height=6,fig.width=6}
lic_footprints_all_plot2 <- lic_footprints_all %>% 
  filter(year>=2020) %>% 
  mutate(spp1=case_when(
    spp1=="dover"~"Dover",
    spp1=="sable"~"Sablefish",
    spp1=="shortspine"~"Shortspine",
    spp1=="longspine"~"Longspine"
  )) %>% 
  mutate(spp2=case_when(
    spp2=="dover"~"Dover",
    spp2=="sable"~"Sablefish",
    spp2=="shortspine"~"Shortspine",
    spp2=="longspine"~"Longspine"
  )) %>% 
  unite(pair,spp1,spp2,sep="~",remove=F) %>% 
  group_by(port_name,spp1,spp2) %>% 
  mutate(anomaly=sum_lic-sum_lic[year==2020]) %>% 
  ungroup() %>%
  ggplot(aes(year,anomaly,color=pair))+
  geom_point(alpha=0.3,size=0.5)+
  geom_smooth(se=F)+
  geom_hline(yintercept = 0,linetype=2)+
  scale_color_manual(values=pal6_2)+
  labs(x="Year",y="\u0394LIC",color="Species Pair")+
  facet_wrap(~port_name,scales='free_y',nrow=2)+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.text = element_text(size=8),
        legend.position = 'bottom',
        panel.border=element_rect(fill=NA,color='black'))

lic_footprints_all_plot2
ggsave(here('model output','dts paper','footprints_lic_ts.png'),lic_footprints_all_plot2,h=6,w=6)
```

